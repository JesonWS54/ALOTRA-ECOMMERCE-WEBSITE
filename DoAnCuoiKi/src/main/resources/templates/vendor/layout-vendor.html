<!DOCTYPE html>
<!-- /* Layout chính cho khu vực Vendor */ -->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head th:replace="~{vendor/fragments/header-vendor :: header}"></head>

<body>

    <!-- Toast container (cho WebSocket notifications) -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
        <!-- Toasts sẽ được thêm vào đây bằng JavaScript -->
    </div>

    <header th:replace="~{vendor/fragments/nav-vendor :: nav}"></header>

    <!-- Nội dung chính của từng trang con -->
    <main id="main">
        <div layout:fragment="content">
            <!-- Nội dung mặc định nếu trang con không định nghĩa -->
            <p>Vendor Content Placeholder</p>
        </div>
    </main>

    <footer th:replace="~{vendor/fragments/footer-vendor :: footer}"></footer>

    <!-- Nút Scroll to Top -->
    <a href="#" class="scroll-top d-flex align-items-center justify-content-center active"><i class="bi bi-arrow-up-short"></i></a>

    <!-- Preloader (nếu có) -->
    <!-- <div id="preloader"></div> -->

    <!-- Vendor JS Files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script th:src="@{/vendor/aos/aos.js}"></script>
    <script th:src="@{/vendor/glightbox/js/glightbox.min.js}"></script>
    <script th:src="@{/vendor/swiper/swiper-bundle.min.js}"></script>
    <script th:src="@{/vendor/purecounter/purecounter_vanilla.js}"></script>

    <!-- WebSocket Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- Main JS File -->
    <script th:src="@{/assets/js/main.js}"></script>

    <!-- WebSocket Connection Script and General Initialization -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const currentShopId = /*[[${currentShopId}]]*/ null;
        const contextPath = /*[[@{/}]]*/ '/';
        let stompClient = null;
        /*]]>*/

        function connectWebSocketVendor() {
            // --- Logic kết nối WebSocket (giữ nguyên) ---
            if (!currentShopId) { console.log("Shop ID not found for Vendor, WebSocket not connecting."); return; }
            const socketUrl = `${window.location.protocol}//${window.location.host}${contextPath}ws`; console.log("Vendor connecting to WebSocket at:", socketUrl); const socket = new SockJS(socketUrl); stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) { console.log('Vendor connected to WebSocket: ' + frame); const topic = '/topic/orders/' + currentShopId; console.log("Vendor subscribing to topic:", topic); stompClient.subscribe(topic, function (message) { try { const notification = JSON.parse(message.body); console.log("Received order notification:", notification); showOrderToast(notification); } catch (e) { console.error("Error processing WebSocket message:", e, message.body); } }); }, function(error) { console.error('STOMP connection error: ' + error); }); if (stompClient && stompClient.ws) { stompClient.ws.onclose = function() { console.log('Vendor WebSocket connection closed.'); }; stompClient.ws.onerror = function(error) { console.error('Vendor WebSocket error:', error); }; }
        }

        function showOrderToast(notification) {
            // --- Logic hiển thị Toast (giữ nguyên) ---
            const toastContainer = document.querySelector('.toast-container'); if (!toastContainer) return; const toastId = `toast-${Date.now()}`; const toastHTML = `<div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="10000"><div class="toast-header bg-primary text-white"><i class="bi bi-bell-fill me-2"></i><strong class="me-auto">Đơn Hàng Mới!</strong><small>Vừa xong</small><button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button></div><div class="toast-body">${notification.message || 'Bạn có một đơn hàng mới cần xử lý.'} ${notification.orderId ? `<br><a href="${contextPath}vendor/orders/${notification.orderId}" class="btn btn-sm btn-outline-primary mt-2">Xem chi tiết</a>` : ''}</div></div>`; toastContainer.insertAdjacentHTML('beforeend', toastHTML); const toastElement = document.getElementById(toastId); const toast = new bootstrap.Toast(toastElement); toast.show(); toastElement.addEventListener('hidden.bs.toast', () => { toastElement.remove(); });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- **SỬA LỖI AOS:** Khởi tạo AOS sau khi kiểm tra nó tồn tại ---
            if (typeof AOS !== 'undefined') {
                AOS.init({
                    duration: 800, // Thời gian animation
                    easing: 'ease-in-out', // Kiểu animation
                    once: true, // Chỉ chạy animation một lần
                    mirror: false // Không chạy animation ngược lại khi cuộn lên
                });
                console.log("AOS initialized."); // Log xác nhận
            } else {
                console.error("AOS library is not loaded or defined."); // Log lỗi nếu không tìm thấy AOS
            }
            // --- Kết thúc sửa lỗi AOS ---

            // Khởi tạo các thư viện JS khác nếu cần (Glightbox...)
            // Ví dụ: if (typeof GLightbox !== 'undefined') { const lightbox = GLightbox({...}); }

            // Kết nối WebSocket cho Vendor
            connectWebSocketVendor();
        });
    </script>

    <!--/* Block cho các script riêng của từng trang con */-->
    <th:block layout:fragment="scripts"></th:block>

</body>
</html>
