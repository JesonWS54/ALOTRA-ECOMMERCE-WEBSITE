<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout-user}">

<head>
    <title>Menu Sản Phẩm - AloTra</title>
    <style>
        /* Thêm style cho active category và sorting dropdown */
        .list-group-item.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: #fff;
        }
        .product-card img {
            height: 200px; /* Chiều cao cố định cho ảnh sản phẩm */
            object-fit: cover; /* Đảm bảo ảnh phủ kín */
        }
        /* Style cho Top Selling */
        .top-selling-item img {
            width: 50px; /* Kích thước nhỏ hơn */
            height: 50px;
        }
        .top-selling-item h6 {
             font-size: 0.9rem; /* Chữ nhỏ hơn */
             margin-bottom: 0.1rem;
             overflow: hidden;
             text-overflow: ellipsis;
             white-space: nowrap; /* Đảm bảo tên SP trên 1 dòng */
             max-width: 150px; /* Giới hạn chiều rộng tên SP */
        }
         .top-selling-item span, .top-selling-item small {
              font-size: 0.8rem; /* Chữ nhỏ hơn */
         }
    </style>
</head>

<body>

<div layout:fragment="content">

    <section class="menu-section py-5">
        <div class="container">
            <div class="row">

                <!-- Sidebar: Danh mục & Top Bán Chạy -->
                <div class="col-lg-3">
                    <div class="sidebar sticky-lg-top" style="top: 100px;">
                        <!-- Danh mục -->
                        <div class="widget mb-4" data-aos="fade-up">
                            <h4 class="widget-title mb-3">Danh Mục</h4>
                            <div class="list-group list-group-flush">
                                <!-- Link Tất Cả -->
                                <a th:href="@{/user/menu(sort=${currentSortType})}"
                                   class="list-group-item list-group-item-action"
                                   th:classappend="${currentCategoryId == null ? 'active' : ''}">
                                    <i class="bi bi-list-ul me-2"></i>Tất Cả Sản Phẩm
                                </a>
                                <!-- Lặp qua danh mục -->
                                <a th:each="cat : ${categories}"
                                   th:href="@{/user/menu(category=${cat.id}, sort=${currentSortType})}"
                                   class="list-group-item list-group-item-action"
                                   th:classappend="${currentCategoryId != null and currentCategoryId == cat.id ? 'active' : ''}"
                                   th:text="${cat.name}">
                                    Tên danh mục
                                </a>
                            </div>
                        </div>

                        <!-- Top Bán Chạy -->
                        <div class="widget mb-4" data-aos="fade-up" data-aos-delay="100">
                             <h4 class="widget-title mb-3">Bán Chạy Nhất</h4>
                             <div th:if="${topSellingProducts == null or topSellingProducts.isEmpty()}">
                                 <p class="text-muted small">Chưa có sản phẩm bán chạy nào.</p>
                             </div>
                             <div th:unless="${topSellingProducts == null or topSellingProducts.isEmpty()}" class="vstack gap-3">
                                 <!--/* Lặp qua top sản phẩm bán chạy (ProductDTO) */-->
                                 <div th:each="topProduct : ${topSellingProducts}" class="d-flex align-items-center top-selling-item">
                                     <a th:href="@{/user/product/{id}(id=${topProduct.id})}" class="flex-shrink-0">
                                         <!-- Lấy ảnh đầu tiên từ list images -->
                                         <img th:with="imageUrl=${!#lists.isEmpty(topProduct.images) ? topProduct.images[0] : null}"
                                              th:src="${imageUrl ?: 'https://placehold.co/60x60/eee/ccc?text=Top'}"
                                              onerror="this.src='https://placehold.co/60x60/eee/ccc?text=Top'"
                                              alt="Top Product" class="rounded me-2">
                                     </a>
                                     <div class="flex-grow-1">
                                         <h6 class="mb-0"><a th:href="@{/user/product/{id}(id=${topProduct.id})}" class="text-dark text-decoration-none" th:text="${topProduct.name}">Tên SP</a></h6>
                                         <span class="text-danger fw-semibold d-block" th:text="${#numbers.formatDecimal(topProduct.basePrice, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">Giá</span>
                                         <small class="d-block text-muted" th:text="'Đã bán: ' + ${topProduct.soldCount}">Đã bán</small>
                                     </div>
                                 </div>
                             </div>
                        </div>

                    </div> <!-- /.sidebar -->
                </div> <!-- /.col-lg-3 -->

                <!-- Main Content: Sản phẩm & Phân trang -->
                <div class="col-lg-9">
                    <div class="products-area">
                        <!-- Header: Tên danh mục/Tất cả & Sắp xếp -->
                        <div class="d-flex justify-content-between align-items-center mb-4" data-aos="fade-up">
                             <h3 class="mb-0 h4" th:text="${selectedCategoryName ?: 'Tất Cả Sản Phẩm'}">Tất Cả Sản Phẩm</h3>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    Sắp xếp theo:
                                    <span th:switch="${currentSortType}">
                                        <span th:case="'bestSelling'">Bán chạy nhất</span>
                                        <span th:case="'rating'">Đánh giá cao</span>
                                        <span th:case="'popular'">Phổ biến</span>
                                        <span th:case="*" >Mới nhất</span> <!-- Mặc định -->
                                    </span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortDropdown">
                                    <li><a class="dropdown-item" th:classappend="${currentSortType == 'newest' ? 'active' : ''}" th:href="@{/user/menu(category=${currentCategoryId}, sort='newest')}">Mới nhất</a></li>
                                    <li><a class="dropdown-item" th:classappend="${currentSortType == 'bestSelling' ? 'active' : ''}" th:href="@{/user/menu(category=${currentCategoryId}, sort='bestSelling')}">Bán chạy nhất</a></li>
                                    <li><a class="dropdown-item" th:classappend="${currentSortType == 'rating' ? 'active' : ''}" th:href="@{/user/menu(category=${currentCategoryId}, sort='rating')}">Đánh giá cao</a></li>
                                    <li><a class="dropdown-item" th:classappend="${currentSortType == 'popular' ? 'active' : ''}" th:href="@{/user/menu(category=${currentCategoryId}, sort='popular')}">Phổ biến (Nhiều đánh giá)</a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- Danh sách sản phẩm -->
                        <div th:if="${productPage == null or productPage.empty}" data-aos="fade-up">
                            <p class="text-center text-muted mt-5">Không tìm thấy sản phẩm nào phù hợp.</p>
                        </div>
                        <div th:unless="${productPage == null or productPage.empty}" class="row g-4">
                            <!--/* Lặp qua danh sách sản phẩm (ProductDTO) */-->
                             <div th:each="product, productStat : ${productPage.content}" class="col-md-6 col-lg-4 d-flex align-items-stretch" data-aos="fade-up" th:attr="data-aos-delay=${(productStat.index % 3) * 100}">
                                 <div class="card product-card w-100 shadow-sm border-0 h-100">
                                     <a th:href="@{/user/product/{id}(id=${product.id})}">
                                         <!-- Lấy ảnh đầu tiên từ list images -->
                                         <img th:with="imageUrl=${!#lists.isEmpty(product.images) ? product.images[0] : null}"
                                              th:src="${imageUrl ?: 'https://placehold.co/400x300/eee/ccc?text=AloTra'}"
                                              onerror="this.src='https://placehold.co/400x300/eee/ccc?text=AloTra'"
                                              class="card-img-top" th:alt="${product.name}">
                                     </a>
                                     <div class="card-body d-flex flex-column text-center">
                                         <h5 class="card-title h6 mb-1">
                                             <a th:href="@{/user/product/{id}(id=${product.id})}" class="text-dark text-decoration-none" th:text="${product.name}">Tên sản phẩm</a>
                                         </h5>
                                         <p class="card-text text-muted small mb-2" th:text="'Shop: ' + ${product.shopName}">Tên Shop</p>
                                          <p class="card-text text-muted small mb-2" th:text="'Danh mục: ' + ${product.categoryName}">Danh mục</p>
                                         <p class="card-text product-price text-danger fw-semibold mt-auto mb-2" th:text="${#numbers.formatDecimal(product.basePrice, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">
                                             45.000 VNĐ
                                         </p>
                                         <!-- Form Add to Cart -->
                                         <form th:action="@{/user/cart/add}" method="post" class="mt-2">
                                             <input type="hidden" name="productId" th:value="${product.id}" />
                                             <input type="hidden" name="quantity" value="1" /> <!-- Mặc định thêm 1 -->
                                             <button type="submit" class="btn btn-outline-primary btn-sm w-100" th:disabled="${product.stockQuantity != null and product.stockQuantity <= 0}">
                                                 <i class="bi bi-cart-plus me-1"></i>
                                                 <span th:if="${product.stockQuantity != null and product.stockQuantity > 0}">Thêm vào giỏ</span>
                                                 <span th:unless="${product.stockQuantity != null and product.stockQuantity > 0}">Hết hàng</span>
                                             </button>
                                         </form>
                                     </div>
                                 </div>
                             </div>
                        </div>

                        <!-- Phân trang -->
                         <nav th:if="${productPage != null and productPage.totalPages > 1}" aria-label="Product pagination" class="mt-5 d-flex justify-content-center" data-aos="fade-up">
                             <ul class="pagination">
                                 <!-- Nút Previous -->
                                 <li class="page-item" th:classappend="${productPage.first ? 'disabled' : ''}">
                                     <a class="page-link" th:href="@{/user/menu(category=${currentCategoryId}, sort=${currentSortType}, page=${productPage.number - 1}, size=${pageSize})}" aria-label="Previous">
                                         <span aria-hidden="true">&laquo;</span>
                                     </a>
                                 </li>

                                 <!-- Các trang số - Hiển thị tối đa 5 trang gần trang hiện tại -->
                                 <th:block th:with="
                                     startPage=${T(java.lang.Math).max(0, productPage.number - 2)},
                                     endPage=${T(java.lang.Math).min(productPage.totalPages - 1, productPage.number + 2)}
                                 ">
                                     <!-- Link trang đầu và dấu ... nếu cần -->
                                     <li class="page-item" th:if="${startPage > 0}">
                                         <a class="page-link" th:href="@{/user/menu(category=${currentCategoryId}, sort=${currentSortType}, page=0, size=${pageSize})}">1</a>
                                     </li>
                                     <li class="page-item disabled" th:if="${startPage > 1}"><span class="page-link">...</span></li>

                                     <!-- Các trang ở giữa -->
                                     <li class="page-item" th:each="i : ${#numbers.sequence(startPage, endPage)}" th:classappend="${i == productPage.number ? 'active' : ''}">
                                         <a class="page-link" th:href="@{/user/menu(category=${currentCategoryId}, sort=${currentSortType}, page=${i}, size=${pageSize})}" th:text="${i + 1}">1</a>
                                     </li>

                                     <!-- Dấu ... và link trang cuối nếu cần -->
                                     <li class="page-item disabled" th:if="${endPage < productPage.totalPages - 2}"><span class="page-link">...</span></li>
                                     <li class="page-item" th:if="${endPage < productPage.totalPages - 1}">
                                         <a class="page-link" th:href="@{/user/menu(category=${currentCategoryId}, sort=${currentSortType}, page=${productPage.totalPages - 1}, size=${pageSize})}" th:text="${productPage.totalPages}"></a>
                                     </li>
                                 </th:block>

                                 <!-- Nút Next -->
                                 <li class="page-item" th:classappend="${productPage.last ? 'disabled' : ''}">
                                     <a class="page-link" th:href="@{/user/menu(category=${currentCategoryId}, sort=${currentSortType}, page=${productPage.number + 1}, size=${pageSize})}" aria-label="Next">
                                         <span aria-hidden="true">&raquo;</span>
                                     </a>
                                 </li>
                             </ul>
                         </nav>

                    </div> <!-- /.products-area -->
                </div> <!-- /.col-lg-9 -->
            </div> <!-- /.row -->
        </div> <!-- /.container -->
    </section> <!-- /.menu-section -->

</div>

</body>
</html>