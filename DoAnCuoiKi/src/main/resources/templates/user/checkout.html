<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout-user}">

<head>
    <title>Thanh Toán - AloTra</title>
    <style>
        .list-group-item.active {
            z-index: 2;
            color: var(--bs-list-group-active-color);
            background-color: var(--primary-color); /* Sử dụng màu chính */
            border-color: var(--primary-color);
        }
        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .checkout-summary .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            color: var(--text-muted);
        }
        .checkout-summary .summary-item.total {
            font-weight: bold;
            font-size: 1.2rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            color: var(--dark-color);
        }
        .checkout-summary .summary-item.discount {
            color: var(--bs-success); /* Màu xanh cho giảm giá */
            font-weight: 500;
        }
        .address-item { cursor: pointer; }
    </style>
</head>

<body>

<div layout:fragment="content">
    <section class="checkout-section py-5 bg-light">
        <div class="container">

            <div class="section-header text-center mb-5" data-aos="fade-up">
                <h2>Thanh Toán Đơn Hàng</h2>
                <p>Vui lòng kiểm tra thông tin đơn hàng và địa chỉ nhận hàng.</p>
            </div>

            <!--/* Thông báo lỗi chung nếu có */-->
             <div th:if="${errorMessage}" class="alert alert-danger" role="alert" data-aos="fade-up">
                 <i class="bi bi-exclamation-triangle-fill me-2"></i>
                 <span th:text="${errorMessage}"></span> <a th:href="@{/user/cart}" class="alert-link">Quay lại Giỏ hàng</a>.
             </div>

            <form th:if="${cartView != null and !#lists.isEmpty(cartView.items)}"
                  th:action="@{/user/checkout/place-order}" method="post" id="checkoutForm">

                <div class="row g-4">

                    <!-- Cột trái: Địa chỉ & Phương thức thanh toán -->
                    <div class="col-lg-7" data-aos="fade-right">
                        <!-- Địa chỉ giao hàng -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white py-3">
                                <h4 class="mb-0 h5"><i class="bi bi-geo-alt-fill me-2 text-primary"></i>Chọn Địa Chỉ Giao Hàng</h4>
                            </div>
                            <div class="card-body">
                                <div th:if="${addresses == null or #lists.isEmpty(addresses)}">
                                    <p>Bạn chưa có địa chỉ nào. Vui lòng <a th:href="@{/user/profile}">thêm địa chỉ mới</a>.</p>
                                    <!-- Disable nút đặt hàng nếu không có địa chỉ -->
                                    <script>document.getElementById('placeOrderBtn').disabled = true;</script>
                                </div>
                                <div th:unless="${addresses == null or #lists.isEmpty(addresses)}">
                                    <input type="hidden" name="addressId" id="selectedAddressId" th:value="${defaultAddress != null ? defaultAddress.id : addresses[0].id}" required>
                                    <div class="list-group list-group-flush address-list">
                                        <div th:each="addr : ${addresses}" class="list-group-item list-group-item-action address-item py-3"
                                             th:classappend="${defaultAddress != null and defaultAddress.id == addr.id} ? 'active' : ''"
                                             th:data-address-id="${addr.id}" onclick="selectAddress(this)">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1" th:text="${addr.fullName}">Tên người nhận</h6>
                                                <small th:if="${addr.isDefault}" class="badge bg-secondary rounded-pill">Mặc định</small>
                                            </div>
                                            <p class="mb-1 small" th:text="${addr.phone}">Số điện thoại</p>
                                            <p class="mb-0 small text-muted" th:text="${addr.fullAddressText}">Địa chỉ chi tiết</p>
                                        </div>
                                    </div>
                                    <a th:href="@{/user/profile}" class="btn btn-outline-secondary btn-sm mt-3"><i class="bi bi-plus-lg me-1"></i>Thêm địa chỉ mới</a>
                                </div>
                            </div>
                        </div>

                        <!-- Phương thức thanh toán -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-white py-3">
                                <h4 class="mb-0 h5"><i class="bi bi-credit-card-fill me-2 text-primary"></i>Chọn Phương Thức Thanh Toán</h4>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentCod" value="COD" checked>
                                    <label class="form-check-label" for="paymentCod">
                                        <i class="bi bi-cash-coin me-1"></i> Thanh toán khi nhận hàng (COD)
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentVnpay" value="VNPAY">
                                    <label class="form-check-label" for="paymentVnpay">
                                        <img src="https://sandbox.vnpayment.vn/apis/assets/images/logo-VNPAY-QR-1.svg" alt="VNPAY" style="height: 20px;" class="me-1"> Thanh toán qua VNPAY
                                    </label>
                                </div>
                                <!-- Thêm MOMO nếu cần -->
                                <!-- <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentMomo" value="MOMO">
                                    <label class="form-check-label" for="paymentMomo">
                                        <img src="[URL_LOGO_MOMO]" alt="MOMO" style="height: 20px;" class="me-1"> Thanh toán qua MOMO
                                    </label>
                                </div> -->
                                <div class="mb-3 mt-3">
                                     <label for="notes" class="form-label small text-muted">Ghi chú cho đơn hàng (tùy chọn)</label>
                                     <textarea class="form-control form-control-sm" id="notes" name="notes" rows="2" placeholder="Ví dụ: Giao hàng giờ hành chính..."></textarea>
                                 </div>
                            </div>
                        </div>
                    </div> <!-- /.col-lg-7 -->

                    <!-- Cột phải: Tóm tắt đơn hàng -->
                    <div class="col-lg-5" data-aos="fade-left">
                        <div class="card shadow-sm sticky-lg-top" style="top: 100px;">
                            <div class="card-header bg-white py-3">
                                <h4 class="mb-0 h5"><i class="bi bi-receipt-cutoff me-2 text-primary"></i>Tóm Tắt Đơn Hàng</h4>
                            </div>
                            <div class="card-body">
                                <!-- Danh sách sản phẩm -->
                                <div class="order-items mb-3" style="max-height: 250px; overflow-y: auto;">
                                     <div th:each="item : ${cartView.items}" class="d-flex align-items-center mb-3 border-bottom pb-2">
                                         <img th:src="${item.productThumbnail ?: 'https://placehold.co/60x60/eee/ccc'}"
                                              onerror="this.src='https://placehold.co/60x60/eee/ccc'"
                                              alt="Product Image" class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                         <div class="flex-grow-1 me-3">
                                             <div class="fw-semibold small" th:text="${item.productName}">Tên sản phẩm</div>
                                             <div class="text-muted small" th:text="'SL: ' + ${item.quantity}">SL: 1</div>
                                         </div>
                                         <div class="text-end small">
                                             <span class="fw-semibold" th:text="${#numbers.formatDecimal(item.priceAtAdd * item.quantity, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">Thành tiền</span>
                                         </div>
                                     </div>
                                </div>

                                <!-- Chi tiết tổng tiền -->
                                <div class="checkout-summary">
                                    <div class="summary-item">
                                        <span>Tạm tính</span>
                                        <span th:text="${#numbers.formatDecimal(cartView.subtotal, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0 VNĐ</span>
                                    </div>
                                    <div class="summary-item">
                                        <span>Phí vận chuyển</span>
                                        <span th:text="${cartView.shippingCost != null ? #numbers.formatDecimal(cartView.shippingCost, 0, 'COMMA', 0, 'POINT') + ' VNĐ' : '--'}">--</span>
                                    </div>
                                    <!--/* Thuế (nếu có) */-->
                                    <!-- <div class="summary-item" th:if="${cartView.tax != null and cartView.tax > 0}">
                                        <span>Thuế</span>
                                        <span th:text="${#numbers.formatDecimal(cartView.tax, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0 VNĐ</span>
                                    </div> -->
                                    <div class="summary-item discount" th:if="${cartView.discount != null and cartView.discount > 0}">
                                         <span>Giảm giá (<span th:if="${cartView.appliedVoucher != null}" th:text="${cartView.appliedVoucher.code}">VOUCHER</span>)</span>
                                         <span th:text="'- ' + ${#numbers.formatDecimal(cartView.discount, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">- 0 VNĐ</span>
                                     </div>
                                    <div class="summary-item total">
                                        <span>Tổng cộng</span>
                                        <span th:text="${#numbers.formatDecimal(cartView.total, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0 VNĐ</span>
                                    </div>
                                </div>

                                <div class="d-grid mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg" id="placeOrderBtn" th:disabled="${addresses == null or #lists.isEmpty(addresses)}">
                                        <i class="bi bi-bag-check-fill me-2"></i>Đặt Hàng
                                    </button>
                                </div>
                                <p class="small text-muted text-center mt-3">Bằng việc nhấn Đặt Hàng, bạn đồng ý với <a href="#">Điều khoản sử dụng</a> của AloTra.</p>

                            </div> <!-- /.card-body -->
                        </div> <!-- /.card -->
                    </div> <!-- /.col-lg-5 -->

                </div> <!-- /.row -->
            </form>

             <div th:unless="${cartView != null and !#lists.isEmpty(cartView.items)}" class="text-center mt-5" data-aos="fade-up">
                 <i class="bi bi-cart-x fs-1 text-muted"></i>
                 <p class="lead mt-3">Giỏ hàng của bạn đang trống.</p>
                 <a th:href="@{/user/menu}" class="btn btn-primary"><i class="bi bi-arrow-left me-2"></i>Tiếp tục mua sắm</a>
             </div>

        </div> <!-- /.container -->
    </section> <!-- /.checkout-section -->
</div>

<th:block layout:fragment="scripts">
    <script>
        function selectAddress(element) {
            // Bỏ active class khỏi tất cả item
            document.querySelectorAll('.address-item.active').forEach(item => {
                item.classList.remove('active');
            });
            // Thêm active class cho item được click
            element.classList.add('active');
            // Cập nhật giá trị input ẩn
            document.getElementById('selectedAddressId').value = element.getAttribute('data-address-id');
        }
    </script>
</th:block>

</body>
</html>