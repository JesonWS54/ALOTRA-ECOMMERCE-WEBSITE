<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout-user}">
<head>
    <title>Hồ sơ cá nhân - AloTra</title>
</head>
<body>

<div layout:fragment="content">

    <section class="profile-section py-5 bg-light">
        <div class="container">
            <div class="section-header mb-4">
                <h2>Hồ sơ cá nhân</h2>
            </div>

            <!--/* Messages */-->
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div class="row g-4">
                <!--/* Avatar and Basic Info Column */-->
                <div class="col-lg-4">
                    <div class="card shadow-sm mb-4">
                        <div class="card-body text-center">
                            <!--/* Avatar Image */-->
                            <img th:src="${account.avatarUrl != null ? account.avatarUrl : 'https://placehold.co/150x150/E8F7F4/333?text=Avatar'}"
                                 alt="Avatar" class="rounded-circle img-thumbnail mb-3" style="width: 150px; height: 150px; object-fit: cover;"
                                 onerror="this.src='https://placehold.co/150x150/E8F7F4/333?text=Avatar'">

                            <h5 class="card-title mb-1" th:text="${account.fullName ?: account.username}">Tên User</h5>
                            <p class="text-muted mb-3" th:text="${account.email}">email@example.com</p>

                            <!--/* Avatar Upload Form */-->
                            <form th:action="@{/user/profile/update-avatar}" method="post" enctype="multipart/form-data">
                                <label for="avatarFile" class="btn btn-outline-primary btn-sm mb-2">Đổi ảnh đại diện</label>
                                <input type="file" id="avatarFile" name="avatarFile" class="d-none" onchange="this.form.submit()">
                                <small class="d-block text-muted">Chọn ảnh mới (JPG, PNG, <= 10MB)</small>
                            </form>
                        </div>
                    </div>
                </div>

                <!--/* Detailed Info Column */-->
                <div class="col-lg-8">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h5 class="mb-0">Thông tin chi tiết</h5>
                        </div>
                        <div class="card-body">
                            <!--/* Update Profile Form */-->
                            <form th:action="@{/user/profile/update}" method="post">
                                <div class="row mb-3">
                                    <label for="fullName" class="col-sm-3 col-form-label">Họ và tên</label>
                                    <div class="col-sm-9">
                                        <!--/* Full Name Input */-->
                                        <input type="text" class="form-control" id="fullName" name="fullName" th:value="${account.fullName}">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="username" class="col-sm-3 col-form-label">Tên đăng nhập</label>
                                    <div class="col-sm-9">
                                        <!--/* Username (Readonly) */-->
                                        <input type="text" class="form-control" id="username" name="username" th:value="${account.username}" readonly disabled>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="email" class="col-sm-3 col-form-label">Email</label>
                                    <div class="col-sm-9">
                                        <!--/* Email (Readonly) */-->
                                        <input type="email" class="form-control" id="email" name="email" th:value="${account.email}" readonly disabled>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label for="phone" class="col-sm-3 col-form-label">Số điện thoại</label>
                                    <div class="col-sm-9">
                                        <!--/* Phone Input */-->
                                        <input type="text" class="form-control" id="phone" name="phone" th:value="${account.phone}">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Vai trò</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" th:value="${account.role}" readonly disabled>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label class="col-sm-3 col-form-label">Ngày tham gia</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" th:value="${account.createdAt != null ? #temporals.format(account.createdAt, 'dd/MM/yyyy HH:mm') : 'N/A'}" readonly disabled>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end">
                                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!--/* Address Section */-->
            <hr class="my-5">
            <div class="row mt-5">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                         <h4 class="mb-0">Sổ địa chỉ</h4>
                         <!--/* Add Address Button */-->
                         <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                              <i class="bi bi-plus-circle"></i> Thêm địa chỉ mới
                         </button>
                    </div>

                    <div class="list-group shadow-sm">
                        <!--/* Empty Address List Message */-->
                        <div th:if="${#lists.isEmpty(addresses)}">
                            <p class="list-group-item">Bạn chưa có địa chỉ nào.</p>
                        </div>

                        <!--/* Address List Item Loop */-->
                        <a th:each="addr : ${addresses}" href="#" class="list-group-item list-group-item-action" aria-current="true">
                            <div class="d-flex w-100 justify-content-between">
                                <div>
                                    <h5 class="mb-1">
                                        <span th:text="${addr.fullName}"></span> | <span th:text="${addr.phone}"></span>
                                        <span th:if="${addr.isDefault}" class="badge bg-primary ms-2">Mặc định</span>
                                    </h5>
                                    <p class="mb-1" th:text="${addr.fullAddressText}"></p>
                                    <small class="text-muted" th:text="${addr.street} + (${addr.wardCode != null ? ', P/X ' + addr.wardCode : ''}) + (${addr.districtCode != null ? ', Q/H ' + addr.districtCode : ''}) + (${addr.provinceCode != null ? ', T/TP ' + addr.provinceCode : ''})"></small>
                                </div>
                                <div class="address-actions d-flex flex-column align-items-end">
                                    <!--/* Address Action Buttons */-->
                                    <div class="mb-2">
                                        <!--/* Set Default Button (shown if not default) */-->
                                        <button th:unless="${addr.isDefault}" type="button" class="btn btn-outline-success btn-sm" th:onclick="|setDefaultAddress('${addr.id}')|">Đặt làm mặc định</button>
                                        <!--/* Delete Button */-->
                                        <button type="button" class="btn btn-outline-danger btn-sm ms-1" th:onclick="|deleteAddress('${addr.id}')|">Xóa</button>
                                        <!--/* TODO: Add Edit Button Here */-->
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

        </div> <!-- End Container -->
    </section>

    <!--/* Add Address Modal */-->
    <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addAddressModalLabel">Thêm địa chỉ mới</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <!--/* Add Address Form */-->
          <form th:action="@{/user/profile/address/add}" method="post" th:object="${newAddress}">
              <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6 mb-3">
                            <label for="newFullName" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newFullName" th:field="*{fullName}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newPhone" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newPhone" th:field="*{phone}" required>
                        </div>
                         <!--/* Full Address Text Input */-->
                         <div class="col-12 mb-3">
                              <label for="newFullAddressText" class="form-label">Địa chỉ cụ thể <span class="text-danger">*</span></label>
                              <textarea class="form-control" id="newFullAddressText" rows="3" th:field="*{fullAddressText}" placeholder="Ví dụ: Số nhà 123, Ngõ 45, Đường ABC..." required></textarea>
                         </div>
                         <!--/* Optional Address Codes (Province, District, Ward) */-->
                         <div class="col-md-4 mb-3">
                             <label for="newProvinceCode" class="form-label">Tỉnh/Thành phố</label>
                             <!--/* TODO: Replace with dropdown populated by API */-->
                             <input type="text" class="form-control" id="newProvinceCode" th:field="*{provinceCode}" placeholder="(Để trống)">
                        </div>
                         <div class="col-md-4 mb-3">
                             <label for="newDistrictCode" class="form-label">Quận/Huyện</label>
                             <!--/* TODO: Replace with dropdown populated by API */-->
                             <input type="text" class="form-control" id="newDistrictCode" th:field="*{districtCode}" placeholder="(Để trống)">
                         </div>
                         <div class="col-md-4 mb-3">
                              <label for="newWardCode" class="form-label">Phường/Xã</label>
                              <!--/* TODO: Replace with dropdown populated by API */-->
                              <input type="text" class="form-control" id="newWardCode" th:field="*{wardCode}" placeholder="(Để trống)">
                         </div>
                        <div class="col-12 mb-3">
                             <label for="newStreet" class="form-label">Tên đường (Nếu có)</label>
                             <input type="text" class="form-control" id="newStreet" th:field="*{street}">
                        </div>

                    </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="submit" class="btn btn-primary">Lưu địa chỉ</button>
              </div>
          </form>
        </div>
      </div>
    </div>

    <!--/* Hidden forms for DELETE and SET DEFAULT actions */-->
    <form id="deleteAddressForm" method="post" style="display: none;"></form>
    <form id="setDefaultAddressForm" method="post" style="display: none;"></form>

    <!--/* JavaScript for address actions - Sửa lỗi URL */-->
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Lấy context path (ví dụ: /DoAnCuoiKi) từ Thymeleaf
        const contextPath = /*[[@{/}]]*/ '/';
        
        function deleteAddress(addressId) {
            if (confirm('Bạn có chắc chắn muốn xóa địa chỉ này?')) {
                const form = document.getElementById('deleteAddressForm');
                // Tạo URL đầy đủ bằng cách ghép context path với đường dẫn tương đối
                const deleteUrlBase = contextPath + 'user/profile/address/delete/'; 
                form.action = deleteUrlBase + addressId; // Ghép ID vào cuối
                form.submit();
            }
        }

        function setDefaultAddress(addressId) {
             if (confirm('Bạn có chắc chắn muốn đặt địa chỉ này làm mặc định?')) {
                const form = document.getElementById('setDefaultAddressForm');
                // Tạo URL đầy đủ
                const setDefaultUrlBase = contextPath + 'user/profile/address/set-default/'; 
                form.action = setDefaultUrlBase + addressId; // Ghép ID vào cuối
                form.submit();
             }
        }
        /*]]>*/
    </script>

</div> <!-- End layout fragment -->

</body>
</html>

