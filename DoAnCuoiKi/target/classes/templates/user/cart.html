<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout-user}">

<head>
    <title>Giỏ Hàng - AloTra</title>
    <style>
        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.25rem;
        }
        .quantity-input { max-width: 60px; }
        .order-summary {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            position: sticky;
            top: 100px; /* Adjust based on your header height */
        }
         /* Style cho thông báo voucher */
         .voucher-applied {
             background-color: #e2f9e4;
             border-left: 4px solid #28a745;
             padding: 0.5rem 1rem;
             margin-bottom: 1rem;
             font-size: 0.9rem;
         }
         .voucher-applied .remove-voucher {
             font-size: 0.8rem;
             color: #dc3545;
             cursor: pointer;
             text-decoration: underline;
         }
    </style>
</head>

<body>

<div layout:fragment="content">

    <section class="cart-section py-5">
        <div class="container">

            <div class="section-header text-center mb-5" data-aos="fade-up">
                <h2>Giỏ Hàng Của Bạn</h2>
            </div>

            <!--/* Hiển thị thông báo thành công/lỗi chung */-->
             <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                 <i class="bi bi-check-circle-fill me-2"></i>
                 <span th:text="${successMessage}"></span>
                 <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
             </div>
              <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  <span th:text="${errorMessage}"></span>
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>

            <!--/* Kiểm tra giỏ hàng có rỗng không */-->
            <div th:if="${cartView == null or cartView.items == null or cartView.items.isEmpty()}" class="text-center py-5" data-aos="fade-up">
                 <i class="bi bi-cart-x fs-1 text-muted mb-3"></i>
                 <h4>Giỏ hàng của bạn đang trống.</h4>
                 <p class="text-muted">Hãy thêm sản phẩm vào giỏ để tiếp tục mua sắm nhé!</p>
                 <a th:href="@{/user/menu}" class="btn btn-primary mt-3">
                     <i class="bi bi-arrow-left me-2"></i>Tiếp tục mua sắm
                 </a>
             </div>

            <!--/* Hiển thị giỏ hàng nếu không rỗng */-->
            <div th:unless="${cartView == null or cartView.items == null or cartView.items.isEmpty()}" class="row g-5">

                <!-- Cột trái: Danh sách sản phẩm -->
                <div class="col-lg-8" data-aos="fade-right">
                    <div class="cart-items">
                        <h4 class="mb-3">Sản phẩm trong giỏ (<span th:text="${cartView.totalItems}">0</span>)</h4>

                        <!-- Lặp qua từng sản phẩm -->
                        <div th:each="item, itemStat : ${cartView.items}" class="card cart-item mb-3 shadow-sm border-0">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <!-- Ảnh sản phẩm -->
                                    <div class="col-auto">
                                        <img th:src="${item.productThumbnail ?: 'https://placehold.co/80x80/eee/ccc?text=AloTra'}"
                                             onerror="this.src='https://placehold.co/80x80/eee/ccc?text=AloTra'"
                                             th:alt="${item.productName}">
                                    </div>
                                    <!-- Tên sản phẩm -->
                                    <div class="col">
                                        <h6 class="mb-1" th:text="${item.productName}">Tên sản phẩm</h6>
                                        <!-- <small class="text-muted">Mô tả ngắn...</small> -->
                                    </div>
                                    <!-- Giá -->
                                    <div class="col-md-2 text-md-end">
                                         <span class="fw-semibold" th:text="${#numbers.formatDecimal(item.priceAtAdd, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                                    </div>
                                    <!-- Số lượng -->
                                     <div class="col-md-2">
                                         <form th:action="@{/user/cart/update}" method="post" class="d-flex align-items-center justify-content-center quantity-form">
                                             <input type="hidden" name="itemId" th:value="${item.id}" />
                                             <button type="button" class="btn btn-sm btn-outline-secondary px-2 py-1" onclick="adjustCartQuantity(this, -1)">-</button>
                                             <input type="number" name="quantity" class="form-control form-control-sm text-center quantity-input mx-1"
                                                    th:value="${item.quantity}" min="1" max="99" aria-label="Số lượng" onchange="this.form.submit()"> <!-- Tự submit khi đổi -->
                                             <button type="button" class="btn btn-sm btn-outline-secondary px-2 py-1" onclick="adjustCartQuantity(this, 1)">+</button>
                                         </form>
                                     </div>
                                    <!-- Tổng tiền item -->
                                     <div class="col-md-2 text-md-end">
                                         <span class="fw-bold" th:text="${#numbers.formatDecimal(item.priceAtAdd * item.quantity, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                                     </div>
                                    <!-- Nút xóa -->
                                    <div class="col-auto">
                                        <form th:action="@{/user/cart/remove}" method="post">
                                            <input type="hidden" name="itemId" th:value="${item.id}" />
                                            <button type="submit" class="btn btn-sm btn-link text-danger p-0" title="Xóa sản phẩm">
                                                <i class="bi bi-trash fs-5"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- End Cart Item -->

                    </div> <!-- End Cart Items -->
                </div> <!-- End col-lg-8 -->

                <!-- Cột phải: Tổng kết đơn hàng -->
                <div class="col-lg-4" data-aos="fade-left">
                    <div class="order-summary">
                        <h4 class="mb-4">Tổng kết đơn hàng</h4>
                        <ul class="list-group list-group-flush mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-2 bg-transparent">
                                Tạm tính
                                <span th:text="${#numbers.formatDecimal(cartView.subtotal, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0 VNĐ</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-2 bg-transparent">
                                Phí vận chuyển
                                <span class="text-muted" th:text="${cartView.shippingCost != null ? #numbers.formatDecimal(cartView.shippingCost, 0, 'COMMA', 0, 'POINT') + ' VNĐ' : '--'}">--</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-2 bg-transparent">
                                Thuế (VAT 10% nếu có)
                                <span class="text-muted" th:text="${cartView.tax != null ? #numbers.formatDecimal(cartView.tax, 0, 'COMMA', 0, 'POINT') + ' VNĐ' : '--'}">--</span>
                            </li>
                             <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-2 bg-transparent text-success" th:if="${cartView.discount != null and cartView.discount > 0}">
                                 Giảm giá
                                 <span th:text="'-' + ${#numbers.formatDecimal(cartView.discount, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">-0 VNĐ</span>
                             </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center border-top px-0 pt-3 mt-3 bg-transparent">
                                <strong class="fs-5">Tổng cộng</strong>
                                <strong class="fs-5 text-danger" th:text="${#numbers.formatDecimal(cartView.total, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0 VNĐ</strong>
                            </li>
                        </ul>

                         <!-- Hiển thị thông tin voucher đã áp dụng (nếu có) -->
                         <div th:if="${appliedVoucherCode != null and !appliedVoucherCode.isEmpty()}" class="voucher-applied">
                             <span>Đã áp dụng: <strong th:text="${appliedVoucherCode}">VOUCHERCODE</strong></span>
                             <a th:href="@{/user/cart/remove-voucher}" class="remove-voucher ms-2">(Xóa)</a>
                         </div>

                        <!-- Mã giảm giá -->
                        <form th:action="@{/user/cart/apply-voucher}" method="post" class="mb-4">
                            <label for="voucherCode" class="form-label">Mã giảm giá</label>
                             <div class="input-group">
                                 <input type="text" class="form-control" id="voucherCode" name="voucherCode" placeholder="Nhập mã giảm giá" th:value="${appliedVoucherCode}"> <!-- Hiển thị lại code nếu có -->
                                 <button class="btn btn-secondary" type="submit">Áp dụng</button>
                             </div>
                        </form>

                        <!-- Nút thanh toán -->
                        <form th:action="@{/user/checkout}" method="get">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">Tiến hành thanh toán</button>
                            </div>
                        </form>
                         <div class="text-center mt-3">
                              <a th:href="@{/user/menu}" class="text-decoration-none text-muted"><i class="bi bi-arrow-left me-1"></i> Tiếp tục mua sắm</a>
                         </div>

                    </div> <!-- End Order Summary -->
                </div> <!-- End col-lg-4 -->

            </div> <!-- End row unless -->

        </div> <!-- End container -->
    </section> <!-- End cart-section -->

</div>

<th:block layout:fragment="scripts">
<script>
    // Hàm tăng giảm số lượng và tự submit form
    function adjustCartQuantity(button, change) {
        const form = button.closest('.quantity-form');
        const input = form.querySelector('.quantity-input');
        let currentValue = parseInt(input.value);
        let newValue = currentValue + change;
        const min = parseInt(input.min);
        const max = parseInt(input.max);

        if (newValue >= min && newValue <= max) {
            input.value = newValue;
            // Tự động submit form khi số lượng thay đổi
            form.submit();
        } else if (newValue < min) {
             // Nếu giảm xuống dưới 1, coi như xóa (submit form xóa)
             const itemId = form.querySelector('input[name="itemId"]').value;
             const removeForm = document.querySelector(`form[action$='/remove'] input[value='${itemId}']`)?.closest('form');
             if (removeForm) {
                 if (confirm('Bạn muốn xóa sản phẩm này khỏi giỏ hàng?')) {
                    removeForm.submit();
                 } else {
                     input.value = min; // Reset về 1 nếu không xóa
                 }
             }
        }
    }
</script>
</th:block>

</body>
</html>