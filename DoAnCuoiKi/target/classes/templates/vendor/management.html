<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{vendor/layout-vendor}">

<head>
    <title>Quản Lý Shop - AloTra</title>
    <style>
        /* CSS chung */
        .product-thumbnail { width: 50px; height: 50px; object-fit: cover; border-radius: 0.25rem; }
        .nav-link.validation-error { color: var(--bs-danger); border-color: var(--bs-danger); }
        .tab-pane.validation-error { border: 1px solid var(--bs-danger); border-top: none; padding: 1rem; border-bottom-left-radius: var(--bs-nav-tabs-border-radius); border-bottom-right-radius: var(--bs-nav-tabs-border-radius); }
        .image-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .image-preview-item { position: relative; width: 80px; height: 80px; }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 0.25rem; border: 1px solid #dee2e6; }
        .voucher-code { font-family: monospace; font-weight: bold; }
        .expired { text-decoration: line-through; color: #6c757d; }
        .btn.disabled { cursor: not-allowed; }
        /* Màu trạng thái đơn hàng */
        .status-pending { background-color: #ffc107; color: #343a40; } .status-confirmed { background-color: #17a2b8; } .status-shipping { background-color: #0d6efd; } .status-completed { background-color: #198754; } .status-cancelled, .status-returned { background-color: #dc3545; }
        /* Màu trạng thái thanh toán */
        .payment-unpaid { background-color: #6c757d; } .payment-paid { background-color: #198754; } .payment-refunded { background-color: #ffc107; color: #343a40; }
        /* CSS Card Doanh thu */
        .revenue-card { background-color: #e9f5ff; border-left: 5px solid #0d6efd; }
        .revenue-card .card-title { font-size: 1rem; color: #0d6efd; font-weight: 500; }
        .revenue-card .revenue-value { font-size: 1.75rem; font-weight: 700; color: #343a40; }
    </style>
</head>

<body>

<div layout:fragment="content">
    <section class="management-section py-5">
        <div class="container">

            <!-- Header và Thông báo -->
             <div class="section-header mb-5 text-center">
                <h2 th:text="${hasShop ? 'Quản Lý Cửa Hàng' : 'Đăng Ký Cửa Hàng'}">Quản Lý / Đăng Ký</h2>
                <p th:if="${hasShop and shopInfo != null}" th:text="${shopInfo.shopName}">Tên cửa hàng</p>
            </div>
             <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                 <i class="bi bi-check-circle-fill me-2"></i><span th:text="${successMessage}"></span>
                 <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
             </div>
              <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i><span th:text="${errorMessage}"></span>
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>

             <!-- **** FORM ĐĂNG KÝ (NẾU CHƯA CÓ SHOP) **** -->
             <div th:if="${!hasShop}" class="row justify-content-center">
                 <div class="col-lg-8">
                     <div class="card shadow-sm border-0">
                         <div class="card-body p-4 p-md-5">
                             <h3 class="card-title text-center mb-4">Thông tin cửa hàng của bạn</h3>
                              <div th:if="${param.error == 'register' and #fields.hasErrors('shopDTO.*')}" class="alert alert-danger mb-3">
                                  Vui lòng kiểm tra lại thông tin đăng ký.
                              </div>
                             <form th:action="@{/vendor/management/shop/register}" th:object="${shopDTO}" method="post" enctype="multipart/form-data">
                                  <div class="mb-3">
                                      <label for="regShopName" class="form-label">Tên Cửa Hàng <span class="text-danger">*</span></label>
                                      <input type="text" class="form-control" id="regShopName" th:field="*{shopName}" required>
                                      <div th:if="${#fields.hasErrors('shopName')}" th:errors="*{shopName}" class="invalid-feedback d-block"></div>
                                  </div>
                                  <div class="mb-3">
                                      <label for="regShopDescription" class="form-label">Mô tả</label>
                                      <textarea class="form-control" id="regShopDescription" th:field="*{description}" rows="3"></textarea>
                                  </div>
                                  <div class="mb-3">
                                      <label for="regShopAddress" class="form-label">Địa chỉ (Kho hàng/Shop)</label>
                                      <input type="text" class="form-control" id="regShopAddress" th:field="*{address}">
                                  </div>
                                  <div class="row">
                                      <div class="col-md-6 mb-3">
                                          <label for="regLogoFile" class="form-label">Logo</label>
                                          <input class="form-control" type="file" id="regLogoFile" name="logoFile" accept="image/*">
                                      </div>
                                      <div class="col-md-6 mb-3">
                                          <label for="regBannerFile" class="form-label">Ảnh bìa (Banner)</label>
                                          <input class="form-control" type="file" id="regBannerFile" name="bannerFile" accept="image/*">
                                      </div>
                                  </div>
                                 <div class="d-grid mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg">Đăng Ký Mở Shop</button>
                                 </div>
                             </form>
                         </div>
                     </div>
                 </div>
             </div>
             <!-- **** KẾT THÚC FORM ĐĂNG KÝ **** -->

             <!-- **** KHU VỰC QUẢN LÝ (NẾU ĐÃ CÓ SHOP) **** -->
            <div th:if="${hasShop}">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs nav-fill mb-0" id="managementTabs" role="tablist">
                     <li class="nav-item" role="presentation">
                         <button class="nav-link" th:classappend="${activeTab == 'info' ? 'active' : ''}" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-tab-pane" type="button" role="tab" aria-controls="info-tab-pane" aria-selected="${activeTab == 'info'}">Thông Tin Shop</button>
                     </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" th:classappend="${activeTab == 'products' ? 'active' : ''}" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-tab-pane" type="button" role="tab" aria-controls="products-tab-pane" aria-selected="${activeTab == 'products'}">Sản Phẩm</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" th:classappend="${activeTab == 'orders' ? 'active' : ''}" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-tab-pane" type="button" role="tab" aria-controls="orders-tab-pane" aria-selected="${activeTab == 'orders'}">Đơn Hàng</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" th:classappend="${activeTab == 'vouchers' ? 'active' : ''}" id="vouchers-tab" data-bs-toggle="tab" data-bs-target="#vouchers-tab-pane" type="button" role="tab" aria-controls="vouchers-tab-pane" aria-selected="${activeTab == 'vouchers'}">Khuyến Mãi</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" th:classappend="${activeTab == 'revenue' ? 'active' : ''}" id="revenue-tab" data-bs-toggle="tab" data-bs-target="#revenue-tab-pane" type="button" role="tab" aria-controls="revenue-tab-pane" aria-selected="${activeTab == 'revenue'}">Doanh Thu</button>
                    </li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content border border-top-0 rounded-bottom p-4" id="managementTabsContent">

                     <!-- Tab Thông Tin Shop -->
                     <div class="tab-pane fade" th:classappend="${activeTab == 'info' ? 'show active' : ''}" id="info-tab-pane" role="tabpanel" aria-labelledby="info-tab" tabindex="0">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                              <h4>Thông tin cửa hàng</h4>
                              <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editShopModal" th:disabled="${shopInfo == null}">
                                   <i class="bi bi-pencil me-1"></i>Chỉnh sửa
                               </button>
                          </div>
                          <div th:if="${shopInfo}" class="card border-0">
                              <div class="card-body row">
                                  <div class="col-md-8">
                                      <p><strong>Tên Shop:</strong> <span th:text="${shopInfo.shopName}"></span></p>
                                      <p><strong>Mô tả:</strong> <span th:text="${shopInfo.description ?: 'Chưa có mô tả'}"></span></p>
                                      <p><strong>Địa chỉ:</strong> <span th:text="${shopInfo.address}"></span></p>
                                      <p><strong>Trạng thái:</strong> <span class="badge" th:classappend="${#strings.equalsIgnoreCase(shopInfo.status,'APPROVED') ? 'bg-success' : (#strings.equalsIgnoreCase(shopInfo.status,'PENDING') ? 'bg-warning text-dark' : 'bg-danger')}" th:text="${shopInfo.status}"></span></p>
                                  </div>
                                  <div class="col-md-4 text-md-end">
                                      <p><strong>Logo:</strong><br>
                                          <img th:if="${shopInfo.logoUrl}" th:src="${shopInfo.logoUrl}" alt="Logo" style="max-height: 80px; max-width: 150px;" class="img-thumbnail mb-2">
                                          <span th:unless="${shopInfo.logoUrl}" class="text-muted small">Chưa có logo</span>
                                      </p>
                                      <p><strong>Banner:</strong><br>
                                          <img th:if="${shopInfo.bannerUrl}" th:src="${shopInfo.bannerUrl}" alt="Banner" style="max-width: 200px;" class="img-thumbnail">
                                          <span th:unless="${shopInfo.bannerUrl}" class="text-muted small">Chưa có banner</span>
                                      </p>
                                  </div>
                              </div>
                          </div>
                          <p th:unless="${shopInfo}" class="text-muted">Không tìm thấy thông tin shop.</p>
                     </div>

                    <!-- Tab Sản Phẩm -->
                    <div class="tab-pane fade" th:classappend="${activeTab == 'products' ? 'show active' : ''}" id="products-tab-pane" role="tabpanel" aria-labelledby="products-tab" tabindex="0">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>Danh sách sản phẩm</h4>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                <i class="bi bi-plus-circle me-1"></i>Thêm Sản Phẩm Mới
                            </button>
                        </div>
                         <div th:if="${param.error == 'add' and #fields.hasErrors('newProduct.*')}" class="alert alert-danger mb-3">Vui lòng kiểm tra lại thông tin sản phẩm trong form Thêm mới.</div>
                         <div th:if="${param.error == 'edit' and #fields.hasErrors('editProduct.*')}" class="alert alert-danger mb-3">Vui lòng kiểm tra lại thông tin sản phẩm trong form Chỉnh sửa.</div>

                        <div th:if="${productsPage == null or productsPage.empty}">
                            <p class="text-muted">Bạn chưa có sản phẩm nào.</p>
                        </div>

                        <div th:unless="${productsPage == null or productsPage.empty}" class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Ảnh</th> <th>Tên Sản Phẩm</th> <th>Danh Mục</th> <th>Giá Gốc</th> <th>Kho</th> <th>Đã Bán</th> <th>Trạng Thái</th> <th>Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="product : ${productsPage.content}">
                                         <td>
                                             <img th:src="${product.thumbnailUrl ?: 'https://placehold.co/50x50/eee/ccc?text=SP'}"
                                                  th:attr="onerror='this.onerror=null; this.src=\'' + @{https://placehold.co/50x50/eee/ccc?text=SP} + '\';'"
                                                  class="product-thumbnail" alt="Ảnh SP">
                                         </td>
                                        <td><a th:href="@{/user/product/{id}(id=${product.id})}" target="_blank" th:text="${product.name}"></a></td>
                                        <td th:text="${product.categoryName}"></td>
                                        <td th:text="${#numbers.formatDecimal(product.basePrice, 0, 'POINT', 0, 'COMMA')} + ' VNĐ'"></td> <!-- Sửa lại format -->
                                        <td th:text="${product.stockQuantity}"></td>
                                        <td th:text="${product.soldCount}"></td>
                                        <td><span class="badge" th:classappend="${#strings.equalsIgnoreCase(product.status,'ACTIVE') ? 'bg-success' : 'bg-secondary'}" th:text="${product.status}"></span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-secondary me-1 edit-product-btn" th:attr="data-product-id=${product.id}" data-bs-toggle="modal" data-bs-target="#editProductModal" title="Sửa"><i class="bi bi-pencil"></i></button>
                                             <form th:action="@{/vendor/management/products/delete/{id}(id=${product.id})}" method="post" class="d-inline" onsubmit="return confirm('Bạn có chắc chắn muốn xóa sản phẩm này?');">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Xóa"><i class="bi bi-trash"></i></button>
                                             </form>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Phân trang Sản Phẩm -->
                         <nav th:if="${productsPage != null and productsPage.totalPages > 1}" aria-label="Product pagination" class="mt-4 d-flex justify-content-center">
                             <ul class="pagination pagination-sm">
                                  <li class="page-item" th:classappend="${productsPage.first ? 'disabled' : ''}"> <a class="page-link" th:href="@{/vendor/management(tab='products', page=${productsPage.number - 1}, size=${productsPage.size}, sort=${currentProductSort})}" aria-label="Previous">&laquo;</a> </li>
                                  <th:block th:with="startPage=${T(java.lang.Math).max(0, productsPage.number - 2)}, endPage=${T(java.lang.Math).min(productsPage.totalPages - 1, productsPage.number + 2)}">
                                      <li class="page-item" th:if="${startPage > 0}"><a class="page-link" th:href="@{/vendor/management(tab='products', page=0, size=${productsPage.size}, sort=${currentProductSort})}">1</a></li>
                                      <li class="page-item disabled" th:if="${startPage > 1}"><span class="page-link">...</span></li>
                                      <li class="page-item" th:each="i : ${#numbers.sequence(startPage, endPage)}" th:classappend="${i == productsPage.number ? 'active' : ''}"> <a class="page-link" th:href="@{/vendor/management(tab='products', page=${i}, size=${productsPage.size}, sort=${currentProductSort})}" th:text="${i + 1}"></a> </li>
                                      <li class="page-item disabled" th:if="${endPage < productsPage.totalPages - 2}"><span class="page-link">...</span></li>
                                      <li class="page-item" th:if="${endPage < productsPage.totalPages - 1}"><a class="page-link" th:href="@{/vendor/management(tab='products', page=${productsPage.totalPages - 1}, size=${productsPage.size}, sort=${currentProductSort})}" th:text="${productsPage.totalPages}"></a></li>
                                  </th:block>
                                  <li class="page-item" th:classappend="${productsPage.last ? 'disabled' : ''}"> <a class="page-link" th:href="@{/vendor/management(tab='products', page=${productsPage.number + 1}, size=${productsPage.size}, sort=${currentProductSort})}">&raquo;</a> </li>
                             </ul>
                         </nav>
                    </div>

                    <!-- Tab Đơn Hàng -->
                    <div class="tab-pane fade" th:classappend="${activeTab == 'orders' ? 'show active' : ''}" id="orders-tab-pane" role="tabpanel" aria-labelledby="orders-tab" tabindex="0">
                         <div class="d-flex justify-content-between align-items-center mb-3">
                             <h4>Danh sách đơn hàng</h4>
                             <div class="d-flex align-items-center">
                                 <label for="orderStatusFilter" class="form-label me-2 mb-0 small">Lọc:</label>
                                 <select id="orderStatusFilter" class="form-select form-select-sm w-auto" onchange="filterOrders(this.value)">
                                     <option value="" th:selected="${currentOrderStatus == null}">Tất cả trạng thái</option>
                                     <option th:each="st : ${orderStatuses}" th:value="${st}" th:text="${st}" th:selected="${st == currentOrderStatus}"></option>
                                 </select>
                             </div>
                         </div>

                         <div th:if="${ordersPage == null or ordersPage.empty}">
                             <p class="text-muted">Chưa có đơn hàng nào.</p>
                         </div>

                         <div th:unless="${ordersPage == null or ordersPage.empty}" class="table-responsive">
                             <table class="table table-hover align-middle">
                                 <thead>
                                     <tr>
                                         <th>Mã ĐH</th> <th>Khách Hàng</th> <th>Ngày Đặt</th> <th>Tổng Tiền</th> <th>Trạng Thái</th> <th>Thanh Toán</th> <th>Hành Động</th>
                                     </tr>
                                 </thead>
                                 <tbody>
                                     <tr th:each="order : ${ordersPage.content}">
                                         <td th:text="'#' + ${order.id}">#123</td>
                                         <td th:text="${order.shippingFullName}">Tên Khách</td>
                                         <td th:text="${#temporals.format(order.createdAt, 'dd/MM/yy HH:mm')}">Ngày</td>
                                         <td th:text="${#numbers.formatDecimal(order.finalTotal, 0, 'POINT', 0, 'COMMA')} + ' VNĐ'">Tổng</td>
                                         <td><span class="badge rounded-pill text-white" th:classappend="'status-' + ${#strings.toLowerCase(order.status)}" th:text="${order.status}"></span></td>
                                         <td><span class="badge rounded-pill text-white" th:classappend="'payment-' + ${#strings.toLowerCase(order.paymentStatus)}" th:text="${order.paymentStatus}"></span></td>
                                         <td>
                                             <a th:href="@{/user/order/{id}(id=${order.id})}" target="_blank" class="btn btn-sm btn-outline-info me-1" title="Xem chi tiết"><i class="bi bi-eye"></i></a>
                                             <!-- TODO: Thêm nút xác nhận, giao hàng, hủy -->
                                         </td>
                                     </tr>
                                 </tbody>
                             </table>
                         </div>

                         <!-- Phân trang Đơn Hàng -->
                         <nav th:if="${ordersPage != null and ordersPage.totalPages > 1}" aria-label="Order pagination" class="mt-4 d-flex justify-content-center">
                             <ul class="pagination pagination-sm">
                                 <li class="page-item" th:classappend="${ordersPage.first ? 'disabled' : ''}"> <a class="page-link" th:href="@{/vendor/management(tab='orders', orderStatus=${currentOrderStatus}, orderPage=${ordersPage.number - 1}, orderSize=${ordersPage.size})}">&laquo;</a> </li>
                                 <th:block th:with="startPage=${T(java.lang.Math).max(0, ordersPage.number - 2)}, endPage=${T(java.lang.Math).min(ordersPage.totalPages - 1, ordersPage.number + 2)}">
                                      <li class="page-item" th:if="${startPage > 0}"><a class="page-link" th:href="@{/vendor/management(tab='orders', orderStatus=${currentOrderStatus}, orderPage=0, orderSize=${ordersPage.size})}">1</a></li>
                                      <li class="page-item disabled" th:if="${startPage > 1}"><span class="page-link">...</span></li>
                                      <li class="page-item" th:each="i : ${#numbers.sequence(startPage, endPage)}" th:classappend="${i == ordersPage.number ? 'active' : ''}"> <a class="page-link" th:href="@{/vendor/management(tab='orders', orderStatus=${currentOrderStatus}, orderPage=${i}, orderSize=${ordersPage.size})}" th:text="${i + 1}"></a> </li>
                                      <li class="page-item disabled" th:if="${endPage < ordersPage.totalPages - 2}"><span class="page-link">...</span></li>
                                      <li class="page-item" th:if="${endPage < ordersPage.totalPages - 1}"><a class="page-link" th:href="@{/vendor/management(tab='orders', orderStatus=${currentOrderStatus}, orderPage=${ordersPage.totalPages - 1}, orderSize=${ordersPage.size})}" th:text="${ordersPage.totalPages}"></a></li>
                                  </th:block>
                                  <li class="page-item" th:classappend="${ordersPage.last ? 'disabled' : ''}"> <a class="page-link" th:href="@{/vendor/management(tab='orders', orderStatus=${currentOrderStatus}, orderPage=${ordersPage.number + 1}, orderSize=${ordersPage.size})}">&raquo;</a> </li>
                             </ul>
                         </nav>
                         <script th:inline="javascript"> /* Filter JS */ function filterOrders(status) { let url = /*[[@{/vendor/management(tab='orders')}]]*/ ''; if (status && status !== '') { url += '&orderStatus=' + encodeURIComponent(status); } window.location.href = url; } </script>
                    </div>

                    <!-- Tab Khuyến Mãi (Voucher) -->
                    <div class="tab-pane fade" th:classappend="${activeTab == 'vouchers' ? 'show active' : ''}" id="vouchers-tab-pane" role="tabpanel" aria-labelledby="vouchers-tab" tabindex="0">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>Chương trình khuyến mãi</h4>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addVoucherModal"> <i class="bi bi-plus-circle me-1"></i>Tạo Voucher Mới </button>
                        </div>
                         <div th:if="${param.error == 'addVoucher' and #fields.hasErrors('newVoucher.*')}" class="alert alert-danger mb-3">Vui lòng kiểm tra lại thông tin voucher trong form Tạo mới.</div>
                         <div th:if="${param.error == 'editVoucher' and #fields.hasErrors('editVoucher.*')}" class="alert alert-danger mb-3">Vui lòng kiểm tra lại thông tin voucher trong form Chỉnh sửa.</div>

                        <div th:if="${vouchersPage == null or vouchersPage.empty}"> <p class="text-muted">Bạn chưa tạo voucher nào.</p> </div>

                        <div th:unless="${vouchersPage == null or vouchersPage.empty}" class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead> <tr> <th>Mã Code</th> <th>Mô tả</th> <th>Loại</th> <th>Giá trị</th> <th>Đã dùng / Tổng</th> <th>Hiệu lực</th> <th>Trạng thái</th> <th>Hành động</th> </tr> </thead>
                                <tbody>
                                    <tr th:each="voucher : ${vouchersPage.content}" th:classappend="${#temporals.createNow().isAfter(voucher.endDate)} ? 'expired'">
                                         <td class="voucher-code" th:text="${voucher.code}"></td>
                                         <td th:text="${voucher.description}"></td>
                                         <td th:text="${#strings.equalsIgnoreCase(voucher.discountType, 'PERCENT')} ? '%' : 'VNĐ'"></td>
                                         <td th:text="${#strings.equalsIgnoreCase(voucher.discountType, 'PERCENT')} ? ${voucher.discountValue} + '%' : ${#numbers.formatDecimal(voucher.discountValue, 0, 'POINT', 0, 'COMMA')}"></td>
                                         <td th:text="${voucher.usedCount} + ' / ' + ${voucher.quantity}"></td>
                                         <td th:text="${#temporals.format(voucher.startDate, 'dd/MM/yy HH:mm')} + ' - ' + ${#temporals.format(voucher.endDate, 'dd/MM/yy HH:mm')}"></td>
                                         <td> <span class="badge rounded-pill" th:classappend="${#temporals.createNow().isAfter(voucher.endDate)} ? 'bg-secondary' : (${voucher.usedCount >= voucher.quantity} ? 'bg-warning text-dark' : 'bg-success')" th:text="${#temporals.createNow().isAfter(voucher.endDate)} ? 'Hết hạn' : (${voucher.usedCount >= voucher.quantity} ? 'Hết lượt' : 'Còn hiệu lực')"></span> </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-secondary me-1 edit-voucher-btn" th:attr="data-voucher-id=${voucher.id}" data-bs-toggle="modal" data-bs-target="#editVoucherModal" title="Sửa"> <i class="bi bi-pencil"></i> </button>
                                             <form th:action="@{/vendor/management/vouchers/delete/{id}(id=${voucher.id})}" method="post" class="d-inline" onsubmit="return confirm('Bạn có chắc chắn muốn xóa voucher này?');">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Xóa"> <i class="bi bi-trash"></i> </button>
                                             </form>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Phân trang Voucher -->
                         <nav th:if="${vouchersPage != null and vouchersPage.totalPages > 1}" aria-label="Voucher pagination" class="mt-4 d-flex justify-content-center">
                              <ul class="pagination pagination-sm">
                                  <li class="page-item" th:classappend="${vouchersPage.first ? 'disabled' : ''}"> <a class="page-link" th:href="@{/vendor/management(tab='vouchers', voucherPage=${vouchersPage.number - 1}, voucherSize=${vouchersPage.size})}">&laquo;</a> </li>
                                  <th:block th:with="startPage=${T(java.lang.Math).max(0, vouchersPage.number - 2)}, endPage=${T(java.lang.Math).min(vouchersPage.totalPages - 1, vouchersPage.number + 2)}">
                                       <li class="page-item" th:if="${startPage > 0}"><a class="page-link" th:href="@{/vendor/management(tab='vouchers', voucherPage=0, voucherSize=${vouchersPage.size})}">1</a></li>
                                       <li class="page-item disabled" th:if="${startPage > 1}"><span class="page-link">...</span></li>
                                       <li class="page-item" th:each="i : ${#numbers.sequence(startPage, endPage)}" th:classappend="${i == vouchersPage.number ? 'active' : ''}"> <a class="page-link" th:href="@{/vendor/management(tab='vouchers', voucherPage=${i}, voucherSize=${vouchersPage.size})}" th:text="${i + 1}"></a> </li>
                                       <li class="page-item disabled" th:if="${endPage < vouchersPage.totalPages - 2}"><span class="page-link">...</span></li>
                                       <li class="page-item" th:if="${endPage < vouchersPage.totalPages - 1}"><a class="page-link" th:href="@{/vendor/management(tab='vouchers', voucherPage=${vouchersPage.totalPages - 1}, voucherSize=${vouchersPage.size})}" th:text="${vouchersPage.totalPages}"></a></li>
                                   </th:block>
                                   <li class="page-item" th:classappend="${vouchersPage.last ? 'disabled' : ''}"> <a class="page-link" th:href="@{/vendor/management(tab='vouchers', voucherPage=${vouchersPage.number + 1}, voucherSize=${vouchersPage.size})}">&raquo;</a> </li>
                              </ul>
                         </nav>
                    </div>

                    <!-- Tab Doanh Thu -->
                    <div class="tab-pane fade" th:classappend="${activeTab == 'revenue' ? 'show active' : ''}" id="revenue-tab-pane" role="tabpanel" aria-labelledby="revenue-tab" tabindex="0">
                        <h4>Báo cáo doanh thu</h4>
                        <p class="text-muted mb-4">(Dữ liệu được tính từ các đơn hàng đã hoàn thành)</p>

                        <div class="row">
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card shadow-sm border-0 h-100 revenue-card">
                                    <div class="card-body">
                                        <h5 class="card-title text-uppercase mb-2">Tổng Doanh Thu</h5>
                                        <div class="revenue-value" th:text="${revenueData != null ? #numbers.formatDecimal(revenueData['totalRevenue'], 0, 'POINT', 0, 'COMMA') + ' VNĐ' : '0 VNĐ'}">
                                            0 VNĐ
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- TODO: Thêm các card khác cho doanh thu hôm nay, tháng này... -->
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card shadow-sm border-0 h-100">
                                     <div class="card-body text-center text-muted">
                                         <i class="bi bi-bar-chart-line fs-1 mb-2"></i>
                                         <p>(Biểu đồ doanh thu sắp có)</p>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div> <!-- /.tab-content -->
            </div> <!-- End if hasShop -->

        </div> <!-- /.container -->
    </section>

    <!-- ======================================================= -->
    <!--                       MODALS                          -->
    <!-- ======================================================= -->

    <!-- Modal Thêm Sản Phẩm -->
     <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
         <div class="modal-dialog modal-lg">
             <div class="modal-content">
                 <form th:action="@{/vendor/management/products/add}" th:object="${newProduct}" method="post" enctype="multipart/form-data">
                     <div class="modal-header">
                         <h5 class="modal-title" id="addProductModalLabel">Thêm Sản Phẩm Mới</h5>
                         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                     </div>
                     <div class="modal-body">
                          <div th:if="${param.error == 'add' and #fields.hasErrors('newProduct.*')}" class="alert alert-danger mb-3">
                              Vui lòng kiểm tra lại thông tin sản phẩm.
                          </div>
                          <div class="mb-3">
                              <label for="addProductName" class="form-label">Tên Sản Phẩm <span class="text-danger">*</span></label>
                              <input type="text" class="form-control" id="addProductName" th:field="*{name}" required>
                              <div th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="invalid-feedback d-block"></div>
                          </div>
                          <div class="row">
                              <div class="col-md-6 mb-3">
                                  <label for="addProductCategory" class="form-label">Danh Mục <span class="text-danger">*</span></label>
                                  <select class="form-select" id="addProductCategory" th:field="*{categoryId}" required>
                                      <option selected disabled value="">Chọn danh mục...</option>
                                      <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}">Category Name</option>
                                  </select>
                                   <div th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}" class="invalid-feedback d-block"></div>
                              </div>
                              <div class="col-md-6 mb-3">
                                  <label for="addProductPrice" class="form-label">Giá Bán <span class="text-danger">*</span></label>
                                  <input type="number" class="form-control" id="addProductPrice" th:field="*{basePrice}" step="1000" min="0" required>
                                  <div th:if="${#fields.hasErrors('basePrice')}" th:errors="*{basePrice}" class="invalid-feedback d-block"></div>
                              </div>
                          </div>
                          <div class="mb-3">
                              <label for="addProductDescription" class="form-label">Mô tả</label>
                              <textarea class="form-control" id="addProductDescription" th:field="*{description}" rows="3"></textarea>
                          </div>
                          <div class="mb-3">
                             <label for="addProductStock" class="form-label">Số lượng tồn kho <span class="text-danger">*</span></label>
                             <input type="number" class="form-control" id="addProductStock" th:field="*{stockQuantity}" min="0" value="0" required>
                              <div th:if="${#fields.hasErrors('stockQuantity')}" th:errors="*{stockQuantity}" class="invalid-feedback d-block"></div>
                         </div>
                          <div class="mb-3">
                              <label for="addImageFiles" class="form-label">Hình ảnh sản phẩm</label>
                              <input class="form-control" type="file" id="addImageFiles" name="imageFiles" multiple accept="image/*">
                              <small class="form-text text-muted">Chọn 1 hoặc nhiều ảnh (ảnh đầu tiên sẽ là thumbnail).</small>
                          </div>
                     </div>
                     <div class="modal-footer">
                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                         <button type="submit" class="btn btn-primary">Lưu Sản Phẩm</button>
                     </div>
                 </form>
             </div>
         </div>
     </div>
    <!-- Modal Sửa Sản Phẩm -->
     <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
         <div class="modal-dialog modal-lg">
             <div class="modal-content">
                 <form th:action="@{/vendor/management/products/update/0}" th:object="${editProduct}" method="post" enctype="multipart/form-data" id="editProductForm">
                     <input type="hidden" th:field="*{id}" id="editProductId" />
                     <div class="modal-header">
                         <h5 class="modal-title" id="editProductModalLabel">Chỉnh Sửa Sản Phẩm</h5>
                         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                     </div>
                     <div class="modal-body">
                          <div th:if="${param.error == 'edit' and #fields.hasErrors('editProduct.*')}" class="alert alert-danger mb-3">
                              Vui lòng kiểm tra lại thông tin sản phẩm.
                          </div>
                         <div class="mb-3">
                             <label for="editProductName" class="form-label">Tên Sản Phẩm <span class="text-danger">*</span></label>
                             <input type="text" class="form-control" id="editProductName" th:field="*{name}" required>
                              <div th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="invalid-feedback d-block"></div>
                         </div>
                         <div class="row">
                             <div class="col-md-6 mb-3">
                                 <label for="editProductCategory" class="form-label">Danh Mục <span class="text-danger">*</span></label>
                                 <select class="form-select" id="editProductCategory" th:field="*{categoryId}" required>
                                     <option disabled value="">Chọn danh mục...</option>
                                     <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}">Category Name</option>
                                 </select>
                                  <div th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}" class="invalid-feedback d-block"></div>
                             </div>
                             <div class="col-md-6 mb-3">
                                 <label for="editProductPrice" class="form-label">Giá Bán <span class="text-danger">*</span></label>
                                 <input type="number" class="form-control" id="editProductPrice" th:field="*{basePrice}" step="1000" min="0" required>
                                  <div th:if="${#fields.hasErrors('basePrice')}" th:errors="*{basePrice}" class="invalid-feedback d-block"></div>
                             </div>
                         </div>
                         <div class="mb-3">
                             <label for="editProductDescription" class="form-label">Mô tả</label>
                             <textarea class="form-control" id="editProductDescription" th:field="*{description}" rows="3"></textarea>
                         </div>
                         <div class="mb-3">
                            <label for="editProductStock" class="form-label">Số lượng tồn kho <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="editProductStock" th:field="*{stockQuantity}" min="0" required>
                             <div th:if="${#fields.hasErrors('stockQuantity')}" th:errors="*{stockQuantity}" class="invalid-feedback d-block"></div>
                        </div>
                         <div class="mb-3">
                             <label class="form-label">Hình ảnh hiện tại</label>
                             <div id="editImagePreview" class="image-preview-container">
                                 <p class="text-muted small">Đang tải ảnh...</p>
                             </div>
                         </div>
                         <div class="mb-3">
                             <label for="editImageFiles" class="form-label">Thay đổi hình ảnh (chọn ảnh mới sẽ xóa hết ảnh cũ)</label>
                             <input class="form-control" type="file" id="editImageFiles" name="editImageFiles" multiple accept="image/*">
                             <small class="form-text text-muted">Nếu không chọn, ảnh cũ sẽ được giữ nguyên.</small>
                         </div>
                     </div>
                     <div class="modal-footer">
                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                         <button type="submit" class="btn btn-primary">Lưu Thay Đổi</button>
                     </div>
                 </form>
             </div>
         </div>
     </div>
    <!-- Modal Chỉnh Sửa Shop -->
      <div class="modal fade" id="editShopModal" tabindex="-1" aria-labelledby="editShopModalLabel" aria-hidden="true">
           <div class="modal-dialog modal-lg">
               <div class="modal-content" th:if="${shopInfo}">
                    <div class="modal-header">
                         <h5 class="modal-title" id="editShopModalLabel">Chỉnh Sửa Thông Tin Shop</h5>
                         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                     </div>
                     <div class="modal-body">
                          <div th:if="${param.error == 'editShop' and #fields.hasErrors('shopInfo.*')}" class="alert alert-danger mb-3">
                               Vui lòng kiểm tra lại thông tin shop.
                          </div>
                          <form th:action="@{/vendor/management/shop/update-info}" th:object="${shopInfo}" method="post" id="editShopInfoForm" class="mb-4 border-bottom pb-4">
                               <input type="hidden" th:field="*{id}" />
                               <div class="mb-3">
                                   <label for="editShopName" class="form-label">Tên Shop <span class="text-danger">*</span></label>
                                   <input type="text" class="form-control" id="editShopName" th:field="*{shopName}" required>
                                   <div th:if="${#fields.hasErrors('shopName')}" th:errors="*{shopName}" class="invalid-feedback d-block"></div>
                               </div>
                               <div class="mb-3">
                                   <label for="editShopDescription" class="form-label">Mô tả</label>
                                   <textarea class="form-control" id="editShopDescription" th:field="*{description}" rows="3"></textarea>
                               </div>
                               <div class="mb-3">
                                   <label for="editShopAddress" class="form-label">Địa chỉ</label>
                                   <input type="text" class="form-control" id="editShopAddress" th:field="*{address}">
                               </div>
                               <button type="submit" class="btn btn-primary btn-sm">Lưu Thông Tin</button>
                          </form>
                          <form th:action="@{/vendor/management/shop/update-logo}" method="post" enctype="multipart/form-data" class="mb-4 border-bottom pb-4">
                               <div class="mb-3">
                                   <label for="editShopLogo" class="form-label">Cập nhật Logo</label>
                                   <div class="mb-2">
                                       <img th:if="${shopInfo.logoUrl}" th:src="${shopInfo.logoUrl}" alt="Current Logo" style="max-height: 60px;" class="img-thumbnail me-2">
                                       <span th:unless="${shopInfo.logoUrl}" class="text-muted small">Chưa có logo</span>
                                   </div>
                                   <input class="form-control form-control-sm" type="file" id="editShopLogo" name="logoFile" accept="image/*" required>
                               </div>
                               <button type="submit" class="btn btn-secondary btn-sm">Upload Logo Mới</button>
                          </form>
                          <form th:action="@{/vendor/management/shop/update-banner}" method="post" enctype="multipart/form-data">
                               <div class="mb-3">
                                   <label for="editShopBanner" class="form-label">Cập nhật Banner</label>
                                   <div class="mb-2">
                                        <img th:if="${shopInfo.bannerUrl}" th:src="${shopInfo.bannerUrl}" alt="Current Banner" style="max-width: 150px;" class="img-thumbnail me-2">
                                        <span th:unless="${shopInfo.bannerUrl}" class="text-muted small">Chưa có banner</span>
                                   </div>
                                   <input class="form-control form-control-sm" type="file" id="editShopBanner" name="bannerFile" accept="image/*" required>
                               </div>
                               <button type="submit" class="btn btn-secondary btn-sm">Upload Banner Mới</button>
                          </form>
                     </div>
                     <div class="modal-footer">
                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                     </div>
               </div>
               <!-- Thêm phần xử lý khi shopInfo là null -->
               <div class="modal-content" th:unless="${shopInfo}">
                    <div class="modal-header"><h5 class="modal-title">Lỗi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body"><p>Không tìm thấy thông tin shop.</p></div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
               </div>
           </div>
       </div>
     <!-- Modal Thêm Voucher -->
     <div class="modal fade" id="addVoucherModal" tabindex="-1" aria-labelledby="addVoucherModalLabel" aria-hidden="true">
         <div class="modal-dialog modal-lg">
             <div class="modal-content">
                 <form th:action="@{/vendor/management/vouchers/add}" th:object="${newVoucher}" method="post" id="addVoucherForm">
                     <div class="modal-header">
                         <h5 class="modal-title" id="addVoucherModalLabel">Tạo Voucher Mới</h5>
                         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                     </div>
                     <div class="modal-body">
                         <div th:if="${param.error == 'addVoucher' and #fields.hasErrors('newVoucher.*')}" class="alert alert-danger mb-3">
                             Vui lòng kiểm tra lại thông tin voucher.
                         </div>
                         <div class="mb-3">
                             <label for="addVoucherCode" class="form-label">Mã Voucher <span class="text-danger">*</span></label>
                             <input type="text" class="form-control" th:classappend="${#fields.hasErrors('code')} ? 'is-invalid' : ''" id="addVoucherCode" th:field="*{code}" required placeholder="Ví dụ: FREESHIP15K">
                             <div th:if="${#fields.hasErrors('code')}" th:errors="*{code}" class="invalid-feedback d-block"></div>
                         </div>
                         <div class="mb-3">
                             <label for="addVoucherDescription" class="form-label">Mô tả ngắn</label>
                             <input type="text" class="form-control" id="addVoucherDescription" th:field="*{description}" placeholder="Ví dụ: Giảm 15k phí vận chuyển">
                         </div>
                         <div class="row">
                              <div class="col-md-6 mb-3">
                                  <label for="addVoucherDiscountType" class="form-label">Loại giảm giá <span class="text-danger">*</span></label>
                                  <select class="form-select" th:classappend="${#fields.hasErrors('discountType')} ? 'is-invalid' : ''" id="addVoucherDiscountType" th:field="*{discountType}" required onchange="toggleMaxDiscount()">
                                      <option value="" disabled selected>Chọn loại...</option>
                                      <option value="PERCENT">Theo phần trăm (%)</option>
                                      <option value="FIXED_AMOUNT">Số tiền cố định (VNĐ)</option>
                                  </select>
                                  <div th:if="${#fields.hasErrors('discountType')}" th:errors="*{discountType}" class="invalid-feedback d-block"></div>
                              </div>
                              <div class="col-md-6 mb-3">
                                   <label for="addVoucherDiscountValue" class="form-label">Giá trị giảm <span class="text-danger">*</span></label>
                                   <input type="number" step="any" min="0" class="form-control" th:classappend="${#fields.hasErrors('discountValue')} ? 'is-invalid' : ''" id="addVoucherDiscountValue" th:field="*{discountValue}" required placeholder="Nhập số % hoặc số tiền">
                                   <div th:if="${#fields.hasErrors('discountValue')}" th:errors="*{discountValue}" class="invalid-feedback d-block"></div>
                               </div>
                         </div>
                          <div class="mb-3" id="maxDiscountAmountGroup" style="display: none;">
                              <label for="addVoucherMaxDiscount" class="form-label">Giảm tối đa (VNĐ)</label>
                              <input type="number" step="1000" min="0" class="form-control" th:classappend="${#fields.hasErrors('maxDiscountAmount')} ? 'is-invalid' : ''" id="addVoucherMaxDiscount" th:field="*{maxDiscountAmount}" placeholder="Bỏ trống nếu không giới hạn">
                              <div th:if="${#fields.hasErrors('maxDiscountAmount')}" th:errors="*{maxDiscountAmount}" class="invalid-feedback d-block"></div>
                          </div>
                          <div class="row">
                               <div class="col-md-6 mb-3">
                                   <label for="addVoucherMinOrder" class="form-label">Giá trị đơn hàng tối thiểu (VNĐ)</label>
                                   <input type="number" step="1000" min="0" class="form-control" th:classappend="${#fields.hasErrors('minOrderValue')} ? 'is-invalid' : ''" id="addVoucherMinOrder" th:field="*{minOrderValue}" placeholder="Mặc định là 0">
                                   <div th:if="${#fields.hasErrors('minOrderValue')}" th:errors="*{minOrderValue}" class="invalid-feedback d-block"></div>
                               </div>
                               <div class="col-md-6 mb-3">
                                   <label for="addVoucherQuantity" class="form-label">Tổng số lượt sử dụng <span class="text-danger">*</span></label>
                                   <input type="number" min="1" class="form-control" th:classappend="${#fields.hasErrors('quantity')} ? 'is-invalid' : ''" id="addVoucherQuantity" th:field="*{quantity}" required placeholder="Ví dụ: 100">
                                   <div th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}" class="invalid-feedback d-block"></div>
                               </div>
                          </div>
                          <div class="row">
                               <div class="col-md-6 mb-3">
                                   <label for="addVoucherStartDate" class="form-label">Ngày bắt đầu <span class="text-danger">*</span></label>
                                   <input type="datetime-local" class="form-control" th:classappend="${#fields.hasErrors('startDate')} ? 'is-invalid' : ''" id="addVoucherStartDate" th:field="*{startDate}" required>
                                   <div th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}" class="invalid-feedback d-block"></div>
                               </div>
                               <div class="col-md-6 mb-3">
                                   <label for="addVoucherEndDate" class="form-label">Ngày kết thúc <span class="text-danger">*</span></label>
                                   <input type="datetime-local" class="form-control" th:classappend="${#fields.hasErrors('endDate')} ? 'is-invalid' : ''" id="addVoucherEndDate" th:field="*{endDate}" required>
                                   <div th:if="${#fields.hasErrors('endDate')}" th:errors="*{endDate}" class="invalid-feedback d-block"></div>
                               </div>
                          </div>
                     </div>
                     <div class="modal-footer">
                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                         <button type="submit" class="btn btn-primary">Lưu Voucher</button>
                     </div>
                 </form>
             </div>
         </div>
     </div>
     <!-- Modal Sửa Voucher -->
     <div class="modal fade" id="editVoucherModal" tabindex="-1" aria-labelledby="editVoucherModalLabel" aria-hidden="true">
         <div class="modal-dialog modal-lg">
             <div class="modal-content">
                 <form th:action="@{/vendor/management/vouchers/update/0}" th:object="${editVoucher}" method="post" id="editVoucherForm">
                     <input type="hidden" th:field="*{id}" id="editVoucherId" />
                     <div class="modal-header">
                         <h5 class="modal-title" id="editVoucherModalLabel">Chỉnh Sửa Voucher</h5>
                         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                     </div>
                     <div class="modal-body">
                         <div th:if="${param.error == 'editVoucher' and #fields.hasErrors('editVoucher.*')}" class="alert alert-danger mb-3">
                             Vui lòng kiểm tra lại thông tin voucher.
                         </div>
                         <div class="mb-3">
                             <label for="editVoucherCode" class="form-label">Mã Voucher <span class="text-danger">*</span></label>
                             <input type="text" class="form-control" th:classappend="${#fields.hasErrors('code')} ? 'is-invalid' : ''" id="editVoucherCode" th:field="*{code}" required>
                             <div th:if="${#fields.hasErrors('code')}" th:errors="*{code}" class="invalid-feedback d-block"></div>
                         </div>
                         <div class="mb-3">
                             <label for="editVoucherDescription" class="form-label">Mô tả ngắn</label>
                             <input type="text" class="form-control" id="editVoucherDescription" th:field="*{description}">
                         </div>
                         <div class="row">
                              <div class="col-md-6 mb-3">
                                  <label for="editVoucherDiscountType" class="form-label">Loại giảm giá <span class="text-danger">*</span></label>
                                  <select class="form-select" th:classappend="${#fields.hasErrors('discountType')} ? 'is-invalid' : ''" id="editVoucherDiscountType" th:field="*{discountType}" required onchange="toggleEditMaxDiscount()">
                                      <option value="" disabled>Chọn loại...</option>
                                      <option value="PERCENT">Theo phần trăm (%)</option>
                                      <option value="FIXED_AMOUNT">Số tiền cố định (VNĐ)</option>
                                  </select>
                                  <div th:if="${#fields.hasErrors('discountType')}" th:errors="*{discountType}" class="invalid-feedback d-block"></div>
                              </div>
                              <div class="col-md-6 mb-3">
                                   <label for="editVoucherDiscountValue" class="form-label">Giá trị giảm <span class="text-danger">*</span></label>
                                   <input type="number" step="any" min="0" class="form-control" th:classappend="${#fields.hasErrors('discountValue')} ? 'is-invalid' : ''" id="editVoucherDiscountValue" th:field="*{discountValue}" required>
                                   <div th:if="${#fields.hasErrors('discountValue')}" th:errors="*{discountValue}" class="invalid-feedback d-block"></div>
                               </div>
                         </div>
                         <div class="mb-3" id="editMaxDiscountAmountGroup" style="display: none;">
                              <label for="editVoucherMaxDiscount" class="form-label">Giảm tối đa (VNĐ)</label>
                              <input type="number" step="1000" min="0" class="form-control" th:classappend="${#fields.hasErrors('maxDiscountAmount')} ? 'is-invalid' : ''" id="editVoucherMaxDiscount" th:field="*{maxDiscountAmount}">
                              <div th:if="${#fields.hasErrors('maxDiscountAmount')}" th:errors="*{maxDiscountAmount}" class="invalid-feedback d-block"></div>
                          </div>
                          <div class="row">
                               <div class="col-md-6 mb-3">
                                   <label for="editVoucherMinOrder" class="form-label">Giá trị đơn hàng tối thiểu (VNĐ)</label>
                                   <input type="number" step="1000" min="0" class="form-control" th:classappend="${#fields.hasErrors('minOrderValue')} ? 'is-invalid' : ''" id="editVoucherMinOrder" th:field="*{minOrderValue}">
                                   <div th:if="${#fields.hasErrors('minOrderValue')}" th:errors="*{minOrderValue}" class="invalid-feedback d-block"></div>
                               </div>
                               <div class="col-md-6 mb-3">
                                   <label for="editVoucherQuantity" class="form-label">Tổng số lượt sử dụng <span class="text-danger">*</span></label>
                                   <input type="number" min="1" class="form-control" th:classappend="${#fields.hasErrors('quantity')} ? 'is-invalid' : ''" id="editVoucherQuantity" th:field="*{quantity}" required>
                                   <div th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}" class="invalid-feedback d-block"></div>
                               </div>
                          </div>
                          <div class="row">
                               <div class="col-md-6 mb-3">
                                   <label for="editVoucherStartDate" class="form-label">Ngày bắt đầu <span class="text-danger">*</span></label>
                                   <input type="datetime-local" class="form-control" th:classappend="${#fields.hasErrors('startDate')} ? 'is-invalid' : ''" id="editVoucherStartDate" th:field="*{startDate}" required>
                                   <div th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}" class="invalid-feedback d-block"></div>
                               </div>
                               <div class="col-md-6 mb-3">
                                   <label for="editVoucherEndDate" class="form-label">Ngày kết thúc <span class="text-danger">*</span></label>
                                   <input type="datetime-local" class="form-control" th:classappend="${#fields.hasErrors('endDate')} ? 'is-invalid' : ''" id="editVoucherEndDate" th:field="*{endDate}" required>
                                   <div th:if="${#fields.hasErrors('endDate')}" th:errors="*{endDate}" class="invalid-feedback d-block"></div>
                               </div>
                          </div>
                     </div>
                     <div class="modal-footer">
                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                         <button type="submit" class="btn btn-primary">Lưu Thay Đổi</button>
                     </div>
                 </form>
             </div>
         </div>
     </div>


</div> <!-- /.layout-fragment -->

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        // --- Khai báo biến global cho modal instances ---
        let editProductModalInstance = null;
        let editVoucherModalInstance = null;

        // --- Logic lấy params và flags ---
        const urlParams = new URLSearchParams(window.location.search);
        const addError = urlParams.get('error') === 'add';
        const editError = urlParams.get('error') === 'edit';
        const registerError = urlParams.get('error') === 'register';
        const editShopError = urlParams.get('error') === 'editShop';
        const addVoucherError = urlParams.get('error') === 'addVoucher';
        const editVoucherError = urlParams.get('error') === 'editVoucher';
        const openEditModalShop = /*[[${openEditModal} ?: false]]*/ false;
        const productIdWithError = /*[[${productIdWithError}]]*/ false; // Sửa tên biến này cho nhất quán
        const openAddVoucherModalFlag = /*[[${openAddVoucherModal} ?: false]]*/ false;
        const openEditVoucherModalFlag = /*[[${openEditVoucherModal} ?: false]]*/ false;
        const voucherIdWithError = /*[[${voucherIdWithError}]]*/ false;
        const hasAddProductErrors = /*[[${#fields.hasErrors('newProduct.*')}]]*/ false;
        const hasEditProductErrors = /*[[${#fields.hasErrors('editProduct.*')}]]*/ false;
        const hasEditShopErrors = /*[[${#fields.hasErrors('shopInfo.*')}]]*/ false;
        const hasRegisterShopErrors = /*[[${#fields.hasErrors('shopDTO.*')}]]*/ false;
        const hasAddVoucherErrors = /*[[${#fields.hasErrors('newVoucher.*')}]]*/ false;
        const hasEditVoucherErrors = /*[[${#fields.hasErrors('editVoucher.*')}]]*/ false;


        document.addEventListener('DOMContentLoaded', () => {
              // --- Khởi tạo modal instances ---
              const editProductModalEl = document.getElementById('editProductModal');
              if (editProductModalEl) { editProductModalInstance = new bootstrap.Modal(editProductModalEl); }
              const editVoucherModalEl = document.getElementById('editVoucherModal');
              if (editVoucherModalEl) { editVoucherModalInstance = new bootstrap.Modal(editVoucherModalEl); }

              // --- Logic mở modal khi lỗi ---
              if (addError || hasAddProductErrors) { const el = document.getElementById('addProductModal'); if(el) new bootstrap.Modal(el).show(); }
              // Sửa logic mở modal Edit Product khi lỗi
              if (productIdWithError && (editError || hasEditProductErrors)) { loadProductForEdit(productIdWithError, true); }

              if (editShopError || openEditModalShop || hasEditShopErrors) { const el = document.getElementById('editShopModal'); if(el) new bootstrap.Modal(el).show(); }
              if (registerError || hasRegisterShopErrors) { const el = document.querySelector('form[action$="/shop/register"]'); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center'}); }
              if (addVoucherError || openAddVoucherModalFlag || hasAddVoucherErrors) { const el = document.getElementById('addVoucherModal'); if (el) { new bootstrap.Modal(el).show(); toggleMaxDiscount(); } }
              // Sửa logic mở modal Edit Voucher khi lỗi
              if (voucherIdWithError && (editVoucherError || hasEditVoucherErrors)) { loadVoucherForEdit(voucherIdWithError, true); }

             // --- Gắn event listener cho nút sửa ---
             const editProductButtons = document.querySelectorAll('.edit-product-btn');
             editProductButtons.forEach(button => { button.addEventListener('click', () => { loadProductForEdit(button.getAttribute('data-product-id')); }); });

             const editVoucherButtons = document.querySelectorAll('.edit-voucher-btn');
             editVoucherButtons.forEach(button => { button.addEventListener('click', () => { loadVoucherForEdit(button.getAttribute('data-voucher-id')); }); });

             // Gọi toggle ban đầu cho modal add voucher (nếu nó được mở sẵn do lỗi)
             toggleMaxDiscount();
             // Gọi toggle ban đầu cho modal edit voucher (nếu nó được mở sẵn do lỗi)
             toggleEditMaxDiscount();


        }); // End DOMContentLoaded

        // --- HÀM LOAD SẢN PHẨM ---
         async function loadProductForEdit(productId, forceShowOnError = false) {
             if (!editProductModalInstance) { console.error("Edit product modal instance not found or not initialized!"); return; }
             const editProductForm = document.getElementById('editProductForm');
             const errorDiv = editProductModalInstance._element.querySelector('.alert-danger');
             const previewContainer = document.getElementById('editImagePreview');
             if(editProductForm) editProductForm.reset();
             if(previewContainer) previewContainer.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
             if(errorDiv) errorDiv.style.display = 'none';
             if(editProductForm) { const baseUrl = /*[[@{/vendor/management/products/update/}]]*/ '/vendor/management/products/update/'; editProductForm.action = baseUrl + productId; }
             try {
                 const apiUrlBase = /*[[@{/vendor/management/products/}]]*/ '/vendor/management/products/'; const apiUrl = apiUrlBase + productId + '/edit';
                 console.log("[loadProductForEdit] Fetching product data from:", apiUrl);
                 const response = await fetch(apiUrl);
                 console.log("[loadProductForEdit] Fetch response status:", response.status);
                 if (!response.ok) { const errorText = await response.text(); console.error("[loadProductForEdit] Fetch error response:", errorText); throw new Error(`Status: ${response.status}`); }
                 const product = await response.json();
                 console.log("[loadProductForEdit] Product data received:", product);
                 const editProductId = document.getElementById('editProductId'); const editProductName = document.getElementById('editProductName'); const editProductCategory = document.getElementById('editProductCategory'); const editProductPrice = document.getElementById('editProductPrice'); const editProductDescription = document.getElementById('editProductDescription'); const editProductStock = document.getElementById('editProductStock');
                 if(editProductId) editProductId.value = product.id ?? ''; if(editProductName) editProductName.value = product.name ?? ''; if(editProductCategory) editProductCategory.value = product.categoryId ?? ''; if(editProductPrice) editProductPrice.value = product.basePrice ?? ''; if(editProductDescription) editProductDescription.value = product.description ?? ''; if(editProductStock) editProductStock.value = product.stockQuantity ?? 0;
                 if(previewContainer) { previewContainer.innerHTML = ''; if (product.images && Array.isArray(product.images) && product.images.length > 0) { product.images.forEach(url => { if (url) { const i = document.createElement('div'); i.className = 'image-preview-item'; i.innerHTML = `<img src="${url}" alt="Preview" onerror="this.parentElement.innerHTML='<span class=\\'text-danger small\\'>Ảnh lỗi</span>';">`; previewContainer.appendChild(i); } }); } else { previewContainer.innerHTML = '<p class="text-muted small">Sản phẩm chưa có ảnh.</p>'; } }
                 if (forceShowOnError || !hasEditProductErrors) { console.log("[loadProductForEdit] Showing edit modal for product:", productId); editProductModalInstance.show(); }
                 else { console.log("[loadProductForEdit] Not showing modal due to previous validation errors."); }
             } catch (error) { console.error('[loadProductForEdit] Error:', error); alert('Lỗi tải dữ liệu sản phẩm.'); if (forceShowOnError) { console.log("[loadProductForEdit] Forcing modal show due to error redirect for product:", productId); if (editProductModalInstance) { editProductModalInstance.show(); } else { console.error("[loadProductForEdit] Cannot show modal, instance not available.");} } }
         }

        // --- HÀM JS CHO MODAL ADD VOUCHER ---
        function toggleMaxDiscount() { const s = document.getElementById('addVoucherDiscountType'); const g = document.getElementById('maxDiscountAmountGroup'); if (s && g) { g.style.display = (s.value === 'PERCENT') ? 'block' : 'none'; } }

        // --- HÀM JS CHO MODAL EDIT VOUCHER ---
        function toggleEditMaxDiscount() { const s = document.getElementById('editVoucherDiscountType'); const g = document.getElementById('editMaxDiscountAmountGroup'); if (s && g) { g.style.display = (s.value === 'PERCENT') ? 'block' : 'none'; } }

         // --- HÀM LOAD VOUCHER ---
         async function loadVoucherForEdit(voucherId, forceShowOnError = false) {
             if (!editVoucherModalInstance) { console.error("Edit voucher modal instance not found or not initialized!"); return; }
             const editVoucherForm = document.getElementById('editVoucherForm');
             const errorDiv = editVoucherModalInstance._element.querySelector('.alert-danger');
             if(editVoucherForm) editVoucherForm.reset(); if(errorDiv) errorDiv.style.display = 'none';
             if(editVoucherForm) { const baseUrl = /*[[@{/vendor/management/vouchers/update/}]]*/ '/vendor/management/vouchers/update/'; editVoucherForm.action = baseUrl + voucherId; }
             try {
                 const apiUrlBase = /*[[@{/vendor/management/vouchers/}]]*/ '/vendor/management/vouchers/'; const apiUrl = apiUrlBase + voucherId + '/edit';
                 console.log("[loadVoucherForEdit] Fetching voucher data from:", apiUrl);
                 const response = await fetch(apiUrl);
                 console.log("[loadVoucherForEdit] Fetch response status:", response.status);
                 if (!response.ok) { const errorText = await response.text(); console.error("[loadVoucherForEdit] Fetch error response:", errorText); throw new Error(`Status: ${response.status}`); }
                 const voucher = await response.json();
                 console.log("[loadVoucherForEdit] Voucher data received:", voucher);
                 const f_id = document.getElementById('editVoucherId'); const f_code = document.getElementById('editVoucherCode'); const f_desc = document.getElementById('editVoucherDescription'); const f_type = document.getElementById('editVoucherDiscountType'); const f_value = document.getElementById('editVoucherDiscountValue'); const f_max = document.getElementById('editVoucherMaxDiscount'); const f_min = document.getElementById('editVoucherMinOrder'); const f_qty = document.getElementById('editVoucherQuantity'); const f_start = document.getElementById('editVoucherStartDate'); const f_end = document.getElementById('editVoucherEndDate');
                 if(f_id) f_id.value = voucher.id ?? ''; if(f_code) f_code.value = voucher.code ?? ''; if(f_desc) f_desc.value = voucher.description ?? ''; if(f_type) f_type.value = voucher.discountType ?? ''; if(f_value) f_value.value = voucher.discountValue ?? ''; if(f_max) f_max.value = voucher.maxDiscountAmount ?? ''; if(f_min) f_min.value = voucher.minOrderValue ?? ''; if(f_qty) f_qty.value = voucher.quantity ?? '';
                 // Format datetime-local (YYYY-MM-DDTHH:mm)
                 if(f_start && voucher.startDate) { try { f_start.value = voucher.startDate.substring(0, 16); } catch(e){ console.error("Error formatting start date:", voucher.startDate, e);} } else if(f_start) { f_start.value = '';}
                 if(f_end && voucher.endDate) { try { f_end.value = voucher.endDate.substring(0, 16); } catch(e){ console.error("Error formatting end date:", voucher.endDate, e);} } else if(f_end) { f_end.value = '';}

                 toggleEditMaxDiscount(); // Gọi sau khi điền type
                 if (forceShowOnError || !hasEditVoucherErrors) { console.log("[loadVoucherForEdit] Showing edit modal for voucher:", voucherId); editVoucherModalInstance.show(); }
                 else { console.log("[loadVoucherForEdit] Not showing modal due to previous validation errors."); }
             } catch (error) { console.error('[loadVoucherForEdit] Error:', error); alert('Lỗi tải dữ liệu voucher.'); if (forceShowOnError) { console.log("[loadVoucherForEdit] Forcing modal show due to error redirect for voucher:", voucherId); if (editVoucherModalInstance) { editVoucherModalInstance.show(); } else { console.error("[loadVoucherForEdit] Cannot show modal, instance not available."); } } }
         }

        /*]]>*/
    </script>
</th:block>

</body>
</html>

