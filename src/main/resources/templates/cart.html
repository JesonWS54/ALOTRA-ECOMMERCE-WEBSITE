<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title th:text="${pageTitle}">Giỏ Hàng</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- Breadcrumb -->
        <section class="bg-light py-3">
            <div class="container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a th:href="@{/}">Trang Chủ</a></li>
                        <li class="breadcrumb-item active">Giỏ Hàng</li>
                    </ol>
                </nav>
            </div>
        </section>

        <!-- Cart Content -->
        <section class="py-5">
            <div class="container">
                <h2 class="mb-4 fw-bold">Giỏ Hàng Của Bạn</h2>

                <!-- Empty Cart -->
                <div th:if="${isEmpty}" class="text-center py-5">
                    <i class="bi bi-cart-x display-1 text-muted"></i>
                    <h4 class="mt-4 text-muted">Giỏ hàng trống</h4>
                    <p class="text-muted">Hãy thêm sản phẩm vào giỏ hàng để tiếp tục mua sắm</p>
                    <a th:href="@{/products}" class="btn btn-primary mt-3">
                        <i class="bi bi-arrow-left"></i> Tiếp Tục Mua Sắm
                    </a>
                </div>

                <!-- Cart Items -->
                <div th:if="${!isEmpty}">
                    <div class="row">
                        <!-- Cart Items List -->
                        <div class="col-lg-8 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <!-- Cart Item -->
                                    <div class="cart-item mb-3 pb-3 border-bottom" th:each="item : ${cartItems}">
                                        <div class="row align-items-center">
                                            <!-- Product Image -->
                                            <div class="col-md-2">
                                                <img th:src="${item.product.imageUrl}" 
                                                     th:alt="${item.product.name}"
                                                     class="img-fluid rounded">
                                            </div>
                                            
                                            <!-- Product Info -->
                                            <div class="col-md-4">
                                                <h6 class="mb-1">
                                                    <a th:href="@{/products/{slug}(slug=${item.product.slug})}" 
                                                       class="text-decoration-none text-dark">
                                                        <span th:text="${item.product.name}">Product Name</span>
                                                    </a>
                                                </h6>
                                                <p class="text-muted small mb-0" 
                                                   th:text="${#numbers.formatDecimal(item.product.price, 0, 'COMMA', 0, 'POINT')} + '₫'">
                                                    45,000₫
                                                </p>
                                            </div>
                                            
                                            <!-- Quantity Controls -->
                                            <div class="col-md-3">
                                                <div class="input-group input-group-sm">
                                                    <button class="btn btn-outline-secondary" type="button"
                                                            th:onclick="'updateQuantity(' + ${item.id} + ', ' + ${item.quantity - 1} + ')'">
                                                        <i class="bi bi-dash"></i>
                                                    </button>
                                                    <input type="text" class="form-control text-center" 
                                                           th:value="${item.quantity}" readonly>
                                                    <button class="btn btn-outline-secondary" type="button"
                                                            th:onclick="'updateQuantity(' + ${item.id} + ', ' + ${item.quantity + 1} + ')'">
                                                        <i class="bi bi-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Subtotal & Remove -->
                                            <div class="col-md-2 text-end">
                                                <p class="fw-bold mb-2" 
                                                   th:text="${#numbers.formatDecimal(item.product.price * item.quantity, 0, 'COMMA', 0, 'POINT')} + '₫'">
                                                    90,000₫
                                                </p>
                                                <button class="btn btn-sm btn-link text-danger p-0" 
                                                        th:onclick="'removeFromCart(' + ${item.id} + ')'">
                                                    <i class="bi bi-trash"></i> Xóa
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="col-lg-4">
                            <div class="card shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">Tổng Đơn Hàng</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Tổng sản phẩm:</span>
                                        <span th:text="${totalQuantity}">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Tạm tính:</span>
                                        <span th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + '₫'">
                                            0₫
                                        </span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Phí vận chuyển:</span>
                                        <span class="text-success">Miễn phí</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between mb-3">
                                        <strong>Tổng cộng:</strong>
                                        <strong class="text-primary fs-5" 
                                                th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + '₫'">
                                            0₫
                                        </strong>
                                    </div>
                                    
                                    <!-- Coupon Code -->
                                    <div class="mb-3">
                                        <label class="form-label small">Mã giảm giá</label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control" placeholder="Nhập mã">
                                            <button class="btn btn-outline-secondary" type="button">
                                                Áp dụng
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Checkout Button -->
                                    <a th:href="@{/cart/checkout}" class="btn btn-primary w-100 py-2 fw-bold">
                                        <i class="bi bi-credit-card"></i> Thanh Toán
                                    </a>
                                    
                                    <a th:href="@{/products}" class="btn btn-outline-secondary w-100 mt-2">
                                        <i class="bi bi-arrow-left"></i> Tiếp Tục Mua Sắm
                                    </a>
                                </div>
                            </div>

                            <!-- Payment Methods -->
                            <div class="card shadow-sm mt-3">
                                <div class="card-body">
                                    <h6 class="mb-3">Phương Thức Thanh Toán</h6>
                                    <div class="d-flex justify-content-around">
                                        <img src="https://via.placeholder.com/50x30?text=VISA" alt="Visa">
                                        <img src="https://via.placeholder.com/50x30?text=MC" alt="Mastercard">
                                        <img src="https://via.placeholder.com/50x30?text=COD" alt="COD">
                                        <img src="https://via.placeholder.com/50x30?text=MOMO" alt="MoMo">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div layout:fragment="scripts">
        <script>
            function updateQuantity(itemId, newQuantity) {
                if (newQuantity < 1) {
                    removeFromCart(itemId);
                    return;
                }
                
                $.ajax({
                    url: '/api/cart/item/' + itemId,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ quantity: newQuantity }),
                    success: function() {
                        location.reload();
                    },
                    error: function(xhr) {
                        alert('Lỗi: ' + (xhr.responseJSON?.error || 'Không thể cập nhật số lượng'));
                    }
                });
            }
            
            function removeFromCart(itemId) {
                if (confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                    $.ajax({
                        url: '/api/cart/item/' + itemId,
                        type: 'DELETE',
                        success: function() {
                            location.reload();
                        },
                        error: function(xhr) {
                            alert('Lỗi: ' + (xhr.responseJSON?.error || 'Không thể xóa sản phẩm'));
                        }
                    });
                }
            }
        </script>
    </div>
</body>
</html>
